<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Manager</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestione completa del tuo bar: impegni, programmazione e finanze">
    <meta name="theme-color" content="#007aff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Bar Manager">
    
    <!-- Favicon as data URL -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üç∫</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #c3cfe2;
            --app-bg: rgba(255, 255, 255, 0.95);
            --title-bar-bg-start: #ffffff;
            --title-bar-bg-end: #f5f5f7;
            --border-color: rgba(0, 0, 0, 0.08);
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --sidebar-bg: #f5f5f7;
            --card-bg: white;
            --card-border: rgba(0, 0, 0, 0.06);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            --input-bg: white;
            --input-border: #d2d2d7;
            --task-item-bg: #f5f5f7;
            --task-item-hover: #e8e8ed;
            --icon-btn-bg: white;
            --modal-bg: rgba(0, 0, 0, 0.4);
            --plan-item-bg: white;
            --plan-item-border: #e5e5ea;
            --checkbox-bg: #f5f5f7;
            --checkbox-hover: #e8e8ed;
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1a1a1a;
            --bg-gradient-end: #2d2d2d;
            --app-bg: rgba(30, 30, 30, 0.95);
            --title-bar-bg-start: #2d2d2d;
            --title-bar-bg-end: #252525;
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --sidebar-bg: #252525;
            --card-bg: #2d2d2d;
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --input-bg: #1d1d1f;
            --input-border: #3a3a3c;
            --task-item-bg: #3a3a3c;
            --task-item-hover: #48484a;
            --icon-btn-bg: #3a3a3c;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --plan-item-bg: #2d2d2d;
            --plan-item-border: #3a3a3c;
            --checkbox-bg: #3a3a3c;
            --checkbox-hover: #48484a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--app-bg);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            backdrop-filter: blur(20px);
            transition: background 0.3s ease;
        }

        .title-bar {
            background: linear-gradient(180deg, var(--title-bar-bg-start) 0%, var(--title-bar-bg-end) 100%);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s ease;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
        }

        .light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .light.red { background: #ff5f57; }
        .light.yellow { background: #ffbd2e; }
        .light.green { background: #28c840; }

        h1 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.5px;
            flex: 1;
            text-align: center;
            margin-right: 60px;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            background: var(--task-item-hover);
            transform: scale(1.05);
        }

        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: calc(100vh - 100px);
        }

        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 24px 0;
            transition: background 0.3s ease;
        }

        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .nav-item:hover {
            background: var(--task-item-hover);
        }

        .nav-item.active {
            background: #007aff;
            color: white;
            font-weight: 500;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-area {
            padding: 32px;
            overflow-y: auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            transition: background 0.3s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: var(--text-primary);
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #0051d5;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        [data-theme="dark"] .btn-secondary {
            background: #3a3a3c;
            color: #f5f5f7;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: #48484a;
        }

        .btn-danger {
            background: #ff3b30;
        }

        .btn-danger:hover {
            background: #d62828;
        }

        .btn-success {
            background: #34c759;
        }

        .btn-success:hover {
            background: #2da847;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .task-item {
            background: var(--task-item-bg);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: var(--task-item-hover);
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .task-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--icon-btn-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #007aff;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card.income {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
        }

        .stat-card.expense {
            background: linear-gradient(135deg, #ff3b30 0%, #ff453a 100%);
        }

        .stat-card.balance {
            background: linear-gradient(135deg, #007aff 0%, #0051d5 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--card-border);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-desc {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .transaction-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .transaction-amount {
            font-size: 17px;
            font-weight: 600;
        }

        .transaction-amount.income {
            color: #34c759;
        }

        .transaction-amount.expense {
            color: #ff3b30;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.4px;
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge.personale {
            background: #007aff;
            color: white;
        }

        .badge.attivita {
            background: #ff9500;
            color: white;
        }

        .badge.priority-alta {
            background: #ff3b30;
            color: white;
        }

        .badge.priority-media {
            background: #ff9500;
            color: white;
        }

        .badge.priority-bassa {
            background: #34c759;
            color: white;
        }

        .badge.frequency {
            background: #5856d6;
            color: white;
        }

        .plan-item {
            background: var(--plan-item-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 16px;
            border: 1px solid var(--plan-item-border);
            transition: all 0.2s;
        }

        .plan-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        [data-theme="dark"] .plan-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .plan-title-section {
            flex: 1;
        }

        .plan-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .plan-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .plan-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 8px;
        }

        .plan-actions {
            display: flex;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--checkbox-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: var(--checkbox-hover);
        }

        .checkbox-item.completed {
            opacity: 0.6;
        }

        .checkbox-item.completed .checkbox-label {
            text-decoration: line-through;
        }

        .custom-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #007aff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .checkbox-item.completed .custom-checkbox {
            background: #007aff;
        }

        .custom-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .checkbox-item.completed .custom-checkbox::after {
            opacity: 1;
        }

        .checkbox-label {
            flex: 1;
            font-size: 15px;
            color: var(--text-primary);
        }

        .filter-active {
            background: #007aff !important;
            color: white !important;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 17px;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            padding: 12px;
            color: var(--text-secondary);
            background: var(--task-item-bg);
            border-radius: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 100px;
        }

        .calendar-day:hover {
            background: var(--task-item-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .calendar-day:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            pointer-events: none;
        }

        .calendar-day.today {
            border: 2px solid #34c759;
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
        }

        .calendar-day.has-tasks {
            border-color: #007aff;
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .calendar-day.today .calendar-day-number {
            color: #34c759;
        }

        .calendar-task-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin: 2px;
        }

        .calendar-task-dot.personale {
            background: #007aff;
        }

        .calendar-task-dot.attivita {
            background: #ff9500;
        }

        .calendar-task-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: auto;
        }

        .calendar-task-preview {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .selected-day-task {
            background: var(--task-item-bg);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #007aff;
            transition: all 0.2s;
        }

        .selected-day-task:hover {
            background: var(--task-item-hover);
        }

        .selected-day-task.attivita {
            border-left-color: #ff9500;
        }

        .selected-day-task-time {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .selected-day-task-title {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .selected-day-task-notes {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .transaction-day-item:hover {
            background: var(--task-item-hover) !important;
        }

        /* Event Styles */
        .event-card {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid var(--card-border);
            transition: all 0.3s;
            box-shadow: var(--card-shadow);
        }

        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        [data-theme="dark"] .event-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .event-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            color: white;
            position: relative;
        }

        .event-header.music { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .event-header.dj { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .event-header.party { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .event-header.aperitivo { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .event-header.sport { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .event-header.private { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .event-type-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .event-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .event-date-time {
            font-size: 16px;
            opacity: 0.95;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .event-body {
            padding: 24px;
        }

        .event-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .event-info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--task-item-bg);
            border-radius: 10px;
        }

        .event-info-icon {
            font-size: 24px;
        }

        .event-info-text {
            flex: 1;
        }

        .event-info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .event-info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .event-description {
            background: var(--task-item-bg);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .event-media-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .event-media-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: var(--task-item-bg);
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-media-item:hover {
            transform: scale(1.05);
        }

        .event-media-item img,
        .event-media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .event-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
        }

        .event-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .event-status-badge.published {
            background: #34c759;
            color: white;
        }

        .event-status-badge.draft {
            background: #ff9500;
            color: white;
        }

        .event-expense-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--card-border);
        }

        .event-expense-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .event-expense-item button {
            padding: 8px 12px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .event-expense-item button:hover {
            background: #d62828;
        }

        .event-budget-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .event-budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .event-budget-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            font-size: 18px;
            font-weight: 700;
        }

        .event-budget-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .event-budget-value {
            font-size: 18px;
            font-weight: 700;
        }

        .budget-alert {
            background: #ff3b30;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }

        .budget-ok {
            background: #34c759;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .color-picker:hover {
            transform: scale(1.1);
        }

        .color-picker.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 2px var(--card-bg);
        }

        .budget-category-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 50px;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--card-border);
            transition: all 0.2s;
            align-items: center;
        }

        .budget-category-row:hover {
            background: var(--task-item-hover);
        }

        .budget-category-row:last-child {
            border-bottom: none;
        }

        .budget-category-name {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .budget-category-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .budget-value {
            text-align: right;
            font-size: 15px;
            font-weight: 600;
        }

        .budget-value.positive {
            color: #34c759;
        }

        .budget-value.negative {
            color: #ff3b30;
        }

        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 10000;
            border: 1px solid var(--border-color);
            max-width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .install-banner-text {
            color: var(--text-primary);
            font-size: 15px;
            flex: 1;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            h1 {
                font-size: 18px;
                margin-right: 40px;
            }

            .install-banner {
                flex-direction: column;
                gap: 12px;
            }

            .install-banner-text {
                text-align: center;
            }
        }

        /* Animazione spin per icona aggiornamento */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Barra Aggiornamenti -->
    <div id="updateBar" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 13px;
    ">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-weight: 600;">üì± Bar Manager</span>
            <span style="opacity: 0.8; font-size: 12px;" id="currentVersion">v1.0.0</span>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span id="updateStatus" style="font-size: 12px; opacity: 0.9;">Pronto</span>
            <button onclick="manualCheckUpdate()" id="checkUpdateBtn" style="
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: all 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <span id="checkUpdateIcon">üîÑ</span>
                <span>Verifica Aggiornamenti</span>
            </button>
        </div>
    </div>

    <div class="app-container" style="margin-top: 40px;">
        <div class="title-bar">
            <div class="traffic-lights">
                <div class="light red"></div>
                <div class="light yellow"></div>
                <div class="light green"></div>
            </div>
            <h1>Bar Manager</h1>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Cambia tema">üåô</button>
                <button class="theme-toggle" onclick="logout()" title="Esci" style="font-size: 20px;">üö™</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="nav-item active" data-section="impegni">
                    <div class="nav-icon">üìÖ</div>
                    <span>Impegni</span>
                </div>
                <div class="nav-item" data-section="calendario">
                    <div class="nav-icon">üóìÔ∏è</div>
                    <span>Calendario</span>
                </div>
                <div class="nav-item" data-section="programmazione">
                    <div class="nav-icon">üìã</div>
                    <span>Programmazione</span>
                </div>
                <div class="nav-item" data-section="eventi">
                    <div class="nav-icon">üéâ</div>
                    <span>Eventi</span>
                </div>
                <div class="nav-item" data-section="gonfiabili">
                    <div class="nav-icon">üéà</div>
                    <span>Gonfiabili Service</span>
                </div>
                <div class="nav-item" data-section="finanze">
                    <div class="nav-icon">üí∞</div>
                    <span>Finanze</span>
                </div>
                <div class="nav-item" data-section="riepilogo">
                    <div class="nav-icon">üìà</div>
                    <span>Riepilogo</span>
                </div>
            </div>

            <div class="content-area">
                <!-- Sezione Impegni -->
                <div class="section active" id="impegni">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">I Miei Impegni</h2>
                            <button class="btn" onclick="openTaskModal()">+ Nuovo Impegno</button>
                        </div>
                        <div id="taskList"></div>
                    </div>
                </div>

                <!-- Sezione Calendario -->
                <div class="section" id="calendario">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Calendario Impegni</h2>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button class="btn btn-secondary" onclick="previousMonth()" style="padding: 10px 16px;" title="Mese precedente">‚Üê</button>
                                <span id="currentMonthYear" style="font-size: 16px; font-weight: 600; min-width: 150px; text-align: center;"></span>
                                <button class="btn btn-secondary" onclick="nextMonth()" style="padding: 10px 16px;" title="Mese successivo">‚Üí</button>
                                <button class="btn btn-secondary" onclick="goToToday()" style="padding: 10px 16px;">Oggi</button>
                            </div>
                        </div>
                        
                        <div id="calendarGrid"></div>
                        
                        <div style="margin-top: 24px; display: flex; gap: 16px; flex-wrap: wrap; padding: 16px; background: var(--task-item-bg); border-radius: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #007aff; border-radius: 50%;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Personale</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #ff9500; border-radius: 50%;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Attivit√†</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 12px; height: 12px; background: #34c759; border-radius: 50%;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">Oggi</span>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="selectedDayCard" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title" id="selectedDayTitle">Impegni del Giorno</h2>
                            <button class="btn btn-secondary" onclick="closeSelectedDay()">Chiudi</button>
                        </div>
                        <div id="selectedDayTasks"></div>
                    </div>
                </div>

                <!-- Sezione Programmazione -->
                <div class="section" id="programmazione">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Attivit√† da Programmare</h2>
                            <button class="btn" onclick="openPlanModal()">+ Nuova Attivit√†</button>
                        </div>
                        
                        <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="filterPlans('all')" id="filterAll">Tutte</button>
                            <button class="btn btn-secondary" onclick="filterPlans('giornaliera')" id="filterGiornaliera">Giornaliere</button>
                            <button class="btn btn-secondary" onclick="filterPlans('settimanale')" id="filterSettimanale">Settimanali</button>
                            <button class="btn btn-secondary" onclick="filterPlans('mensile')" id="filterMensile">Mensili</button>
                            <button class="btn btn-secondary" onclick="filterPlans('unica')" id="filterUnica">Una Tantum</button>
                        </div>

                        <div id="planList"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Checklist Giornaliera</h2>
                        </div>
                        <div id="dailyChecklist"></div>
                    </div>
                </div>

                <!-- Sezione Eventi -->
                <div class="section" id="eventi">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Eventi del Bar</h2>
                            <button class="btn" onclick="openEventModal()">+ Nuovo Evento</button>
                        </div>
                        
                        <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-secondary filter-active" onclick="filterEvents('all')" id="filterEventsAll">Tutti</button>
                            <button class="btn btn-secondary" onclick="filterEvents('upcoming')" id="filterEventsUpcoming">Prossimi</button>
                            <button class="btn btn-secondary" onclick="filterEvents('past')" id="filterEventsPast">Passati</button>
                        </div>

                        <div id="eventsList"></div>
                    </div>
                </div>

                <!-- Sezione Gonfiabili Service -->
                <div class="section" id="gonfiabili">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">üéà Gonfiabili Service</h2>
                            <button class="btn" onclick="openGonfiabileModal()">+ Nuovo Noleggio</button>
                        </div>

                        <!-- Stats Cards -->
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="stat-value" style="color: white;" id="gonfiabiliTotali">0</div>
                                <div class="stat-label" style="color: white; opacity: 0.9;">Noleggi Totali</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #34c759 0%, #30d158 100%);">
                                <div class="stat-value" style="color: white;" id="gonfiabiliIncasso">‚Ç¨0</div>
                                <div class="stat-label" style="color: white; opacity: 0.9;">Incasso Totale</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #ff3b30 0%, #ff453a 100%);">
                                <div class="stat-value" style="color: white;" id="gonfiabiliCosti">‚Ç¨0</div>
                                <div class="stat-label" style="color: white; opacity: 0.9;">Costi Totali</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #007aff 0%, #0a84ff 100%);">
                                <div class="stat-value" style="color: white;" id="gonfiabiliGuadagno">‚Ç¨0</div>
                                <div class="stat-label" style="color: white; opacity: 0.9;">Guadagno Netto</div>
                            </div>
                        </div>

                        <!-- Filtri -->
                        <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="filter-btn filter-active" id="filterAllGonfiabili" onclick="filterGonfiabili('all')">Tutti</button>
                            <button class="filter-btn" id="filterAttiviGonfiabili" onclick="filterGonfiabili('attivi')">In Corso</button>
                            <button class="filter-btn" id="filterCompletatiGonfiabili" onclick="filterGonfiabili('completati')">Completati</button>
                        </div>

                        <!-- Lista Noleggi -->
                        <div id="gonfiabiliList"></div>
                    </div>
                </div>

                <!-- Sezione Finanze -->
                <div class="section" id="finanze">
                    <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary filter-active" onclick="switchFinanceView('all')" id="financeViewAll">Tutti</button>
                        <button class="btn btn-secondary" onclick="switchFinanceView('business')" id="financeViewBusiness">üíº Solo Attivit√†</button>
                        <button class="btn btn-secondary" onclick="switchFinanceView('personal')" id="financeViewPersonal">üë§ Solo Personale</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card income">
                            <div class="stat-value" id="totalIncome">‚Ç¨0</div>
                            <div class="stat-label" id="incomeLabelText">Entrate Totali</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-value" id="totalExpense">‚Ç¨0</div>
                            <div class="stat-label" id="expenseLabelText">Uscite Totali</div>
                        </div>
                        <div class="stat-card balance">
                            <div class="stat-value" id="balance">‚Ç¨0</div>
                            <div class="stat-label" id="balanceLabelText">Bilancio</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="stat-value" id="totalDeposits">‚Ç¨0</div>
                            <div class="stat-label">Versamenti Bar</div>
                        </div>
                    </div>

                    <!-- Sezione Versamenti Bar -->
                    <div class="card" id="depositsCard" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title">üí∞ Versamenti Bar</h2>
                            <button class="btn btn-secondary" onclick="toggleDepositsSection()">Nascondi</button>
                        </div>
                        <div id="depositsList"></div>
                    </div>

                    <div style="margin-bottom: 16px; display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="toggleDepositsSection()" id="toggleDepositsBtn">
                            üí∞ Mostra Versamenti (<span id="depositsCount">0</span>)
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Movimenti</h2>
                            <button class="btn" onclick="openTransactionModal()">+ Nuovo Movimento</button>
                        </div>
                        
                        <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <span style="font-size: 14px; font-weight: 500; color: var(--text-secondary);">Periodo:</span>
                            <button class="btn btn-secondary" onclick="filterTransactionsByPeriod('today')" id="filterToday">Oggi</button>
                            <button class="btn btn-secondary" onclick="filterTransactionsByPeriod('week')" id="filterWeek">Settimana</button>
                            <button class="btn btn-secondary" onclick="filterTransactionsByPeriod('month')" id="filterMonth">Mese</button>
                            <button class="btn btn-secondary" onclick="filterTransactionsByPeriod('year')" id="filterYear">Anno</button>
                            <button class="btn btn-secondary filter-active" onclick="filterTransactionsByPeriod('all')" id="filterAllTransactions">Tutti</button>
                        </div>
                        
                        <div id="transactionList"></div>
                    </div>
                </div>

                <!-- Sezione Riepilogo -->
                <div class="section" id="riepilogo">
                    <div class="card">
                        <h2 class="card-title" style="margin-bottom: 20px;">Riepilogo Generale</h2>
                        
                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">üìÖ Impegni</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);" id="summaryTasksTotal">0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Impegni Totali</div>
                                </div>
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);" id="summaryTasksPersonal">0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Personali</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">üéâ Eventi</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);" id="summaryEventsTotal">0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Eventi Totali</div>
                                </div>
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: #34c759;" id="summaryEventsUpcoming">0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Prossimi</div>
                                </div>
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: #f093fb;" id="summaryEventsBudget">‚Ç¨0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Budget Totale</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">üí∞ Finanze</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div style="background: #34c75910; padding: 20px; border-radius: 10px; border: 1px solid #34c75920;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: #34c759;" id="summaryIncome">‚Ç¨0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Entrate</div>
                                </div>
                                <div style="background: #ff3b3010; padding: 20px; border-radius: 10px; border: 1px solid #ff3b3020;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: #ff3b30;" id="summaryExpense">‚Ç¨0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Uscite</div>
                                </div>
                                <div style="background: #007aff10; padding: 20px; border-radius: 10px; border: 1px solid #007aff20;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: #007aff;" id="summaryBalance">‚Ç¨0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Bilancio</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;" id="summaryDeposits">‚Ç¨0</div>
                                    <div style="font-size: 14px; opacity: 0.9;">Versamenti Bar</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 32px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">üí∏ Ultimi Versamenti</h3>
                            <div id="summaryDepositsDetail"></div>
                        </div>

                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">üìã Programmazione</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);" id="summaryPlansTotal">0</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Attivit√† Totali</div>
                                </div>
                                <div style="background: var(--task-item-bg); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary);" id="summaryChecklistProgress">0%</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);">Completamento Oggi</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo Impegno -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Impegno</h3>
            </div>
            <div class="input-group">
                <label>Titolo</label>
                <input type="text" id="taskTitle" placeholder="Es: Ordine bevande">
            </div>
            <div class="input-group">
                <label>Data</label>
                <input type="date" id="taskDate">
            </div>
            <div class="input-group">
                <label>Ora</label>
                <input type="time" id="taskTime">
            </div>
            <div class="input-group">
                <label>Tipo</label>
                <select id="taskType">
                    <option value="personale">Personale</option>
                    <option value="attivita">Attivit√†</option>
                </select>
            </div>
            <div class="input-group">
                <label>Note</label>
                <textarea id="taskNotes" rows="3" placeholder="Dettagli aggiuntivi..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTaskModal()">Annulla</button>
                <button class="btn" onclick="saveTask()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo Movimento -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Movimento</h3>
            </div>
            <div class="input-group">
                <label>Tipo</label>
                <select id="transactionType" onchange="toggleDepositFields()">
                    <option value="income">Entrata</option>
                    <option value="expense">Uscita</option>
                    <option value="deposit">üí∞ Versamento Bar</option>
                </select>
            </div>
            
            <!-- Campi specifici per Versamenti -->
            <div id="depositFields" style="display: none;">
                <div class="input-group">
                    <label>Tipo Versamento</label>
                    <select id="depositType">
                        <option value="bank">üè¶ Versamento in Banca</option>
                        <option value="cash">üíµ Prelievo Contanti</option>
                        <option value="safe">üîí In Cassaforte</option>
                        <option value="owner">üë§ Al Proprietario</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Banca / Destinazione</label>
                    <input type="text" id="depositDestination" placeholder="Es: Intesa Sanpaolo, Conto X">
                </div>
            </div>
            
            <div class="input-group">
                <label>Categoria</label>
                <select id="transactionCategory">
                    <option value="business">üíº Attivit√† (Bar)</option>
                    <option value="personal">üë§ Personale</option>
                </select>
            </div>
            <div class="input-group">
                <label>Importo (‚Ç¨)</label>
                <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="input-group">
                <label>Descrizione</label>
                <input type="text" id="transactionDesc" placeholder="Es: Incasso giornaliero">
            </div>
            <div class="input-group">
                <label>Data</label>
                <input type="date" id="transactionDate">
            </div>
            <div class="input-group">
                <label>Note</label>
                <textarea id="transactionNotes" rows="2" placeholder="Note aggiuntive..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTransactionModal()">Annulla</button>
                <button class="btn" onclick="saveTransaction()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuova Attivit√† Programmata -->
    <div class="modal" id="planModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuova Attivit√† da Programmare</h3>
            </div>
            <div class="input-group">
                <label>Titolo Attivit√†</label>
                <input type="text" id="planTitle" placeholder="Es: Controllo scorte">
            </div>
            <div class="input-group">
                <label>Categoria</label>
                <select id="planCategory">
                    <option value="pulizia">üßπ Pulizia</option>
                    <option value="scorte">üì¶ Scorte e Inventario</option>
                    <option value="fornitori">üöö Fornitori</option>
                    <option value="personale">üë• Gestione Personale</option>
                    <option value="manutenzione">üîß Manutenzione</option>
                    <option value="amministrazione">üìÑ Amministrazione</option>
                    <option value="marketing">üì± Marketing</option>
                    <option value="altro">‚ú® Altro</option>
                </select>
            </div>
            <div class="input-group">
                <label>Frequenza</label>
                <select id="planFrequency">
                    <option value="giornaliera">Giornaliera</option>
                    <option value="settimanale">Settimanale</option>
                    <option value="mensile">Mensile</option>
                    <option value="unica">Una tantum</option>
                </select>
            </div>
            <div class="input-group">
                <label>Priorit√†</label>
                <select id="planPriority">
                    <option value="alta">Alta</option>
                    <option value="media">Media</option>
                    <option value="bassa">Bassa</option>
                </select>
            </div>
            <div class="input-group">
                <label>Descrizione</label>
                <textarea id="planDescription" rows="3" placeholder="Dettagli dell'attivit√†..."></textarea>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="planAddToChecklist" style="width: auto; margin-right: 8px;">
                    Aggiungi alla checklist giornaliera
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePlanModal()">Annulla</button>
                <button class="btn" onclick="savePlan()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuovo Evento -->
    <div class="modal" id="eventModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Evento</h3>
            </div>
            <div class="input-group">
                <label>Nome Evento üéâ</label>
                <input type="text" id="eventTitle" placeholder="Es: Serata Live Music">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="input-group">
                    <label>Data üìÖ</label>
                    <input type="date" id="eventDate">
                </div>
                <div class="input-group">
                    <label>Ora Inizio üïê</label>
                    <input type="time" id="eventTime">
                </div>
            </div>
            <div class="input-group">
                <label>Tipo Evento</label>
                <select id="eventType">
                    <option value="music">üéµ Musica Live</option>
                    <option value="dj">üéß DJ Set</option>
                    <option value="party">üéâ Festa a Tema</option>
                    <option value="aperitivo">üçπ Aperitivo Speciale</option>
                    <option value="sport">‚öΩ Evento Sportivo</option>
                    <option value="private">üéÇ Evento Privato</option>
                    <option value="other">‚ú® Altro</option>
                </select>
            </div>
            <div class="input-group">
                <label>Descrizione / Note üìù</label>
                <textarea id="eventDescription" rows="4" placeholder="Descrivi l'evento, attivit√† previste, informazioni utili..."></textarea>
            </div>
            <div class="input-group">
                <label>Prezzo Ingresso üí∂</label>
                <input type="number" id="eventPrice" placeholder="0.00" step="0.01" min="0">
            </div>
            
            <!-- Budget e Spese Evento -->
            <div style="background: var(--task-item-bg); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">
                    üí∞ Budget & Spese Evento
                </h4>
                
                <div class="input-group">
                    <label>Budget Preventivato</label>
                    <input type="number" id="eventBudget" placeholder="0.00" step="0.01" min="0">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        Quanto prevedi di spendere per questo evento?
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Spese Sostenute</label>
                    <div id="eventExpensesList" style="margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" onclick="addEventExpense()" style="width: 100%;">
                        + Aggiungi Spesa
                    </button>
                </div>
            </div>
            
            <div class="input-group">
                <label>Immagini / Media üì∏</label>
                <input type="file" id="eventMedia" accept="image/*,video/*" multiple style="padding: 10px;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    Carica locandine, foto, video dell'evento
                </div>
            </div>
            <div class="input-group">
                <label>Link / Social üîó</label>
                <input type="url" id="eventLink" placeholder="https://facebook.com/evento oppure Instagram...">
            </div>
            <div class="input-group">
                <label>Artisti / DJ / Band üé§</label>
                <input type="text" id="eventArtist" placeholder="Nome artista o band">
            </div>
            <div class="input-group">
                <label>Idee / To-Do ‚úçÔ∏è</label>
                <textarea id="eventIdeas" rows="3" placeholder="Cosa preparare, cosa comprare, idee per l'evento..."></textarea>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="eventPublished" style="width: auto; margin-right: 8px;">
                    üì¢ Evento pubblicato/promosso
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEventModal()">Annulla</button>
                <button class="btn" onclick="saveEvent()">Salva Evento</button>
            </div>
        </div>
    </div>

    <!-- Modal Noleggio Gonfiabile -->
    <div class="modal" id="gonfiabileModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Noleggio Gonfiabile</h3>
            </div>
            
            <!-- Info Cliente -->
            <div style="background: var(--task-item-bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">üë§ Informazioni Cliente</h4>
                <div class="input-group">
                    <label>Nome Cliente</label>
                    <input type="text" id="gonfiabileCliente" placeholder="Es: Mario Rossi">
                </div>
                <div class="input-group">
                    <label>Telefono</label>
                    <input type="tel" id="gonfiabileTelefono" placeholder="Es: 333 1234567">
                </div>
                <div class="input-group">
                    <label>Indirizzo Evento</label>
                    <input type="text" id="gonfiabileIndirizzo" placeholder="Via, Citt√†">
                </div>
            </div>

            <!-- Date Noleggio -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div class="input-group">
                    <label>Data Uscita (Consegna)</label>
                    <input type="date" id="gonfiabileDataUscita">
                </div>
                <div class="input-group">
                    <label>Ora Uscita</label>
                    <input type="time" id="gonfiabileOraUscita" value="09:00">
                </div>
                <div class="input-group">
                    <label>Data Rientro (Ritiro)</label>
                    <input type="date" id="gonfiabileDataRientro">
                </div>
                <div class="input-group">
                    <label>Ora Rientro</label>
                    <input type="time" id="gonfiabileOraRientro" value="18:00">
                </div>
            </div>

            <!-- Gonfiabile -->
            <div class="input-group">
                <label>Tipo Gonfiabile</label>
                <select id="gonfiabileTipo">
                    <option value="castello">üè∞ Castello</option>
                    <option value="scivolo">üé¢ Scivolo</option>
                    <option value="percorso">üèÉ Percorso Avventura</option>
                    <option value="calcio">‚öΩ Campo Calcio</option>
                    <option value="piscina">üèä Piscina Palline</option>
                    <option value="toro">üêÇ Toro Meccanico</option>
                    <option value="altro">‚ú® Altro</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Nome/Modello Gonfiabile</label>
                <input type="text" id="gonfiabileNome" placeholder="Es: Castello Grande, Scivolo Delfino">
            </div>

            <!-- Economico -->
            <div style="background: var(--task-item-bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">üí∞ Dati Economici</h4>
                <div class="input-group">
                    <label>Prezzo Noleggio (Incasso)</label>
                    <input type="number" id="gonfiabileIncasso" placeholder="0.00" step="0.01" min="0" onchange="calcolaGuadagnoGonfiabile()">
                </div>
                <div class="input-group">
                    <label>Costi Sostenuti</label>
                    <input type="number" id="gonfiabileCosti" placeholder="0.00" step="0.01" min="0" value="0" onchange="calcolaGuadagnoGonfiabile()">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                        Carburante, operatori, manutenzione, ecc.
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: var(--card-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600;">Guadagno Netto:</span>
                    <span id="gonfiabileGuadagnoCalc" style="font-size: 18px; font-weight: 700; color: #34c759;">‚Ç¨0.00</span>
                </div>
            </div>

            <!-- Stato -->
            <div class="input-group">
                <label>Stato Noleggio</label>
                <select id="gonfiabileStato">
                    <option value="attivo">üü¢ In Corso</option>
                    <option value="completato">‚úÖ Completato</option>
                    <option value="annullato">‚ùå Annullato</option>
                </select>
            </div>

            <div class="input-group">
                <label>Note</label>
                <textarea id="gonfiabileNote" rows="3" placeholder="Note aggiuntive, problemi, richieste speciali..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeGonfiabileModal()">Annulla</button>
                <button class="btn" onclick="saveGonfiabile()">Salva</button>
            </div>
        </div>
    </div>

    <script>
        // ========== SISTEMA DI PROTEZIONE E CRITTOGRAFIA ==========
        
        // Password di accesso
        const APP_PASSWORD = 'EliteManager2760@';
        
        // IMPORTANTE: Questa √® la tua password personale!
        // Salvala in un posto sicuro e NON condividerla con nessuno!
        // Password: EliteManager2760@
        
        // ========== SISTEMA AGGIORNAMENTI AUTOMATICI ==========
        const APP_VERSION = '1.0.0'; // Versione corrente dell'app
        const UPDATE_CHECK_INTERVAL = 300000; // Controlla ogni 5 minuti (in millisecondi)
        const UPDATE_URL = 'https://raw.githubusercontent.com/TUO-USERNAME/bar-manager/main/version.json'; // URL da configurare
        const AUTO_UPDATE_ENABLED = false; // DISABILITATO finch√© non configuri GitHub
        const AUTO_CHECK_ENABLED = false; // DISABILITATO - usa solo controllo manuale
        
        // Aggiorna display versione nella barra
        function updateVersionDisplay() {
            const versionEl = document.getElementById('currentVersion');
            if (versionEl) {
                versionEl.textContent = 'v' + APP_VERSION;
            }
        }
        
        // Controllo MANUALE aggiornamenti (dal pulsante)
        async function manualCheckUpdate() {
            const statusEl = document.getElementById('updateStatus');
            const iconEl = document.getElementById('checkUpdateIcon');
            const btnEl = document.getElementById('checkUpdateBtn');
            
            // Controlla se GitHub √® configurato
            if (UPDATE_URL.includes('TUO-USERNAME')) {
                iconEl.textContent = '‚ÑπÔ∏è';
                statusEl.textContent = 'Configura prima GitHub!';
                statusEl.style.color = '#ffa500';
                
                setTimeout(() => {
                    iconEl.textContent = 'üîÑ';
                    statusEl.textContent = 'Pronto';
                    statusEl.style.color = 'white';
                }, 4000);
                return;
            }
            
            // Animazione icona
            iconEl.style.animation = 'spin 1s linear infinite';
            statusEl.textContent = 'Controllo in corso...';
            btnEl.disabled = true;
            btnEl.style.opacity = '0.6';
            btnEl.style.cursor = 'not-allowed';
            
            try {
                const response = await fetch(UPDATE_URL, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Server non raggiungibile');
                }
                
                const updateInfo = await response.json();
                const latestVersion = updateInfo.version;
                const downloadUrl = updateInfo.downloadUrl;
                
                iconEl.style.animation = '';
                
                if (compareVersions(latestVersion, APP_VERSION) > 0) {
                    // Nuova versione disponibile!
                    iconEl.textContent = 'üéâ';
                    statusEl.textContent = `Nuova versione ${latestVersion} disponibile!`;
                    statusEl.style.color = '#34c759';
                    
                    if (AUTO_UPDATE_ENABLED) {
                        await performAutoUpdate(latestVersion, updateInfo.changelog, downloadUrl);
                    } else {
                        showUpdateNotification(latestVersion, updateInfo.changelog, downloadUrl);
                    }
                } else {
                    // Gi√† aggiornato
                    iconEl.textContent = '‚úÖ';
                    statusEl.textContent = 'Sei aggiornato!';
                    statusEl.style.color = '#34c759';
                    
                    setTimeout(() => {
                        iconEl.textContent = 'üîÑ';
                        statusEl.textContent = 'Pronto';
                        statusEl.style.color = 'white';
                    }, 3000);
                }
                
            } catch (error) {
                iconEl.style.animation = '';
                iconEl.textContent = '‚ÑπÔ∏è';
                
                // Messaggio pi√π friendly
                if (error.message.includes('Failed to fetch') || error.message.includes('non raggiungibile')) {
                    statusEl.textContent = 'GitHub non configurato';
                } else {
                    statusEl.textContent = 'Errore: ' + error.message;
                }
                statusEl.style.color = '#ffa500';
                
                setTimeout(() => {
                    iconEl.textContent = 'üîÑ';
                    statusEl.textContent = 'Pronto';
                    statusEl.style.color = 'white';
                }, 5000);
            } finally {
                btnEl.disabled = false;
                btnEl.style.opacity = '1';
                btnEl.style.cursor = 'pointer';
            }
        }
        
        // Controlla aggiornamenti disponibili (automatico in background)
        async function checkForUpdates() {
            try {
                // Prova a recuperare info versione dal server
                const response = await fetch(UPDATE_URL, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    console.log('Controllo aggiornamenti: server non raggiungibile');
                    return;
                }
                
                const updateInfo = await response.json();
                const latestVersion = updateInfo.version;
                const downloadUrl = updateInfo.downloadUrl;
                
                // Confronta versioni
                if (compareVersions(latestVersion, APP_VERSION) > 0) {
                    console.log('üîî Nuova versione disponibile:', latestVersion);
                    
                    // Aggiorna la barra
                    const statusEl = document.getElementById('updateStatus');
                    const iconEl = document.getElementById('checkUpdateIcon');
                    if (statusEl && iconEl) {
                        statusEl.textContent = `Aggiornamento ${latestVersion} disponibile`;
                        statusEl.style.color = '#34c759';
                        iconEl.textContent = 'üîî';
                    }
                    
                    if (AUTO_UPDATE_ENABLED) {
                        // AGGIORNAMENTO AUTOMATICO
                        await performAutoUpdate(latestVersion, updateInfo.changelog, downloadUrl);
                    } else {
                        // Mostra solo notifica
                        showUpdateNotification(latestVersion, updateInfo.changelog, downloadUrl);
                    }
                } else {
                    console.log('‚úÖ App aggiornata alla versione pi√π recente:', APP_VERSION);
                }
            } catch (error) {
                console.log('Errore controllo aggiornamenti:', error.message);
                // Non mostrare errori all'utente, fallisce silenziosamente
            }
        }
        
        // AGGIORNAMENTO AUTOMATICO - Scarica e installa automaticamente
        async function performAutoUpdate(newVersion, changelog, downloadUrl) {
            try {
                // Mostra notifica "Aggiornamento in corso..."
                showUpdateInProgressNotification(newVersion);
                
                // Scarica la nuova versione
                const response = await fetch(downloadUrl, {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error('Download fallito');
                }
                
                const newAppCode = await response.text();
                
                // Salva la nuova versione nel localStorage temporaneo
                localStorage.setItem('barManager_pendingUpdate', newAppCode);
                localStorage.setItem('barManager_pendingVersion', newVersion);
                localStorage.setItem('barManager_updateChangelog', changelog || 'Nuova versione disponibile');
                
                // Mostra notifica di successo e ricarica
                showUpdateSuccessNotification(newVersion, changelog);
                
                // Ricarica automaticamente dopo 3 secondi
                setTimeout(() => {
                    applyUpdate();
                }, 3000);
                
            } catch (error) {
                console.error('Errore auto-aggiornamento:', error);
                // Fallback: mostra notifica manuale
                showUpdateNotification(newVersion, changelog, downloadUrl);
            }
        }
        
        // Applica l'aggiornamento (sostituisce il codice corrente)
        function applyUpdate() {
            const newCode = localStorage.getItem('barManager_pendingUpdate');
            const newVersion = localStorage.getItem('barManager_pendingVersion');
            
            if (newCode) {
                // Crea un blob con il nuovo codice
                const blob = new Blob([newCode], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                // Pulisci il pending update
                localStorage.removeItem('barManager_pendingUpdate');
                localStorage.removeItem('barManager_pendingVersion');
                localStorage.removeItem('barManager_updateChangelog');
                
                // Ricarica la pagina con il nuovo codice
                window.location.href = url;
            } else {
                // Ricarica normale
                window.location.reload(true);
            }
        }
        
        // Mostra notifica "Aggiornamento in corso"
        function showUpdateInProgressNotification(newVersion) {
            dismissUpdateNotification(); // Rimuovi notifiche precedenti
            
            const notification = document.createElement('div');
            notification.id = 'updateNotification';
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="spinner" style="
                        width: 40px;
                        height: 40px;
                        border: 4px solid rgba(255,255,255,0.3);
                        border-top-color: white;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    "></div>
                    <div>
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 4px;">
                            Aggiornamento in corso...
                        </div>
                        <div style="font-size: 13px; opacity: 0.9;">
                            Scaricando versione ${newVersion}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Aggiungi animazione spinner
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Mostra notifica "Aggiornamento completato"
        function showUpdateSuccessNotification(newVersion, changelog) {
            dismissUpdateNotification();
            
            const notification = document.createElement('div');
            notification.id = 'updateNotification';
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="font-size: 32px;">‚úÖ</div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">
                            Aggiornamento Completato!
                        </div>
                        <div style="font-size: 14px; margin-bottom: 4px;">
                            Versione ${newVersion} installata
                        </div>
                        ${changelog ? `
                            <div style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; margin-bottom: 12px;">
                                <strong>Novit√†:</strong><br>${changelog}
                            </div>
                        ` : ''}
                        <div style="font-size: 13px; opacity: 0.9;">
                            Ricaricamento tra 3 secondi...
                        </div>
                        <div style="margin-top: 12px;">
                            <button onclick="applyUpdate()" style="
                                background: white;
                                color: #34c759;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 13px;
                            ">Ricarica Ora</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
        }
        
        // Confronta due versioni (es: "1.0.1" vs "1.0.0")
        function compareVersions(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            
            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const part1 = parts1[i] || 0;
                const part2 = parts2[i] || 0;
                
                if (part1 > part2) return 1;
                if (part1 < part2) return -1;
            }
            return 0;
        }
        
        // Mostra notifica aggiornamento disponibile
        function showUpdateNotification(newVersion, changelog, downloadUrl) {
            const notification = document.createElement('div');
            notification.id = 'updateNotification';
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="font-size: 32px;">üîî</div>
                    <div style="flex: 1;">
                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">
                            Aggiornamento Disponibile!
                        </div>
                        <div style="font-size: 14px; margin-bottom: 4px;">
                            Versione ${newVersion} disponibile
                        </div>
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 12px;">
                            Versione attuale: ${APP_VERSION}
                        </div>
                        ${changelog ? `
                            <div style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 6px; margin-bottom: 12px;">
                                <strong>Novit√†:</strong><br>${changelog}
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 8px;">
                            <button onclick="downloadUpdate('${downloadUrl}')" style="
                                background: white;
                                color: #667eea;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 13px;
                            ">üì• Scarica</button>
                            <button onclick="dismissUpdateNotification()" style="
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                font-weight: 600;
                                cursor: pointer;
                                font-size: 13px;
                            ">Dopo</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Aggiungi animazione CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Salva che abbiamo mostrato la notifica per questa versione
            localStorage.setItem('lastNotifiedVersion', newVersion);
        }
        
        // Scarica aggiornamento
        window.downloadUpdate = function(downloadUrl) {
            // Apri URL in nuova tab
            window.open(downloadUrl, '_blank');
            dismissUpdateNotification();
            
            // Mostra istruzioni
            alert('üì• Aggiornamento in corso!\n\n1. Salva il nuovo file BarManager.html\n2. Chiudi questa versione\n3. Apri il nuovo file\n\n‚ú® I tuoi dati saranno mantenuti!');
        };
        
        // Chiudi notifica
        window.dismissUpdateNotification = function() {
            const notification = document.getElementById('updateNotification');
            if (notification) {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }
        };
        
        // Avvia controllo aggiornamenti periodico
        function startUpdateChecker() {
            // Solo se il controllo automatico √® abilitato
            if (AUTO_CHECK_ENABLED) {
                // Controlla subito all'avvio
                setTimeout(checkForUpdates, 5000); // Dopo 5 secondi dall'avvio
                
                // Poi controlla periodicamente
                setInterval(checkForUpdates, UPDATE_CHECK_INTERVAL);
            } else {
                console.log('‚ÑπÔ∏è Controllo automatico aggiornamenti DISABILITATO - usa il pulsante manuale');
            }
        }
        
        // Chiave per crittografia dati
        let ENCRYPTION_KEY = null;
        let isAuthenticated = false;

        // Funzione di hash per password (SHA-256 simulato)
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Critta i dati
        function encryptData(data) {
            if (!ENCRYPTION_KEY) return data;
            try {
                const jsonStr = JSON.stringify(data);
                const encrypted = btoa(encodeURIComponent(jsonStr + '|' + ENCRYPTION_KEY));
                return encrypted;
            } catch (e) {
                console.error('Errore crittografia:', e);
                return data;
            }
        }

        // Decritta i dati
        function decryptData(encryptedData) {
            if (!ENCRYPTION_KEY || !encryptedData) return null;
            try {
                const decrypted = decodeURIComponent(atob(encryptedData));
                const [jsonStr, key] = decrypted.split('|');
                if (key !== ENCRYPTION_KEY) {
                    console.error('Chiave non valida');
                    return null;
                }
                return JSON.parse(jsonStr);
            } catch (e) {
                // Se fallisce la decrittazione, probabilmente dati non criptati o password sbagliata
                return null;
            }
        }

        // Verifica password
        async function verifyPassword(inputPassword) {
            const hashedInput = await hashPassword(inputPassword);
            const hashedStored = await hashPassword(APP_PASSWORD);
            return hashedInput === hashedStored;
        }

        // Mostra schermata login
        function showLoginScreen() {
            const loginHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                " id="loginScreen">
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 50px;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                        max-width: 400px;
                        width: 90%;
                        text-align: center;
                    ">
                        <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                        <h2 style="
                            font-size: 28px;
                            font-weight: 700;
                            margin-bottom: 10px;
                            color: #1d1d1f;
                        ">Bar Manager</h2>
                        <p style="
                            color: #86868b;
                            margin-bottom: 30px;
                            font-size: 15px;
                        ">Inserisci la password per accedere</p>
                        
                        <input 
                            type="password" 
                            id="passwordInput" 
                            placeholder="Password"
                            style="
                                width: 100%;
                                padding: 15px;
                                border: 2px solid #e5e5ea;
                                border-radius: 10px;
                                font-size: 16px;
                                margin-bottom: 20px;
                                font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
                                box-sizing: border-box;
                            "
                            onkeypress="if(event.key==='Enter') attemptLogin()"
                        >
                        
                        <button 
                            onclick="attemptLogin()"
                            style="
                                width: 100%;
                                padding: 15px;
                                background: #007aff;
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                                font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
                            "
                            onmouseover="this.style.background='#0051d5'"
                            onmouseout="this.style.background='#007aff'"
                        >Accedi</button>
                        
                        <div id="errorMessage" style="
                            color: #ff3b30;
                            margin-top: 15px;
                            font-size: 14px;
                            display: none;
                        ">‚ùå Password errata</div>

                        <div style="
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 1px solid #e5e5ea;
                            color: #86868b;
                            font-size: 13px;
                        ">
                            üîê I tuoi dati sono criptati e protetti
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', loginHTML);
            document.getElementById('passwordInput').focus();
        }

        // Tentativo di login
        async function attemptLogin() {
            const input = document.getElementById('passwordInput');
            const errorMsg = document.getElementById('errorMessage');
            const password = input.value;

            if (!password) {
                errorMsg.textContent = '‚ö†Ô∏è Inserisci una password';
                errorMsg.style.display = 'block';
                return;
            }

            const isValid = await verifyPassword(password);
            
            if (isValid) {
                ENCRYPTION_KEY = await hashPassword(password);
                isAuthenticated = true;
                
                // Salva sessione (scade alla chiusura del browser)
                sessionStorage.setItem('bar_auth_session', ENCRYPTION_KEY);
                
                // Rimuovi schermata login con animazione
                const loginScreen = document.getElementById('loginScreen');
                loginScreen.style.transition = 'opacity 0.3s';
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.remove();
                    initializeApp();
                }, 300);
            } else {
                errorMsg.textContent = '‚ùå Password errata';
                errorMsg.style.display = 'block';
                input.value = '';
                input.style.borderColor = '#ff3b30';
                setTimeout(() => {
                    input.style.borderColor = '#e5e5ea';
                }, 1000);
            }
        }

        // Controlla sessione esistente
        async function checkExistingSession() {
            const savedSession = sessionStorage.getItem('bar_auth_session');
            if (savedSession) {
                // Verifica che la sessione sia valida
                const hashedPassword = await hashPassword(APP_PASSWORD);
                if (savedSession === hashedPassword) {
                    ENCRYPTION_KEY = savedSession;
                    isAuthenticated = true;
                    return true;
                }
            }
            return false;
        }

        // Logout
        function logout() {
            if (confirm('Sei sicuro di voler uscire? Dovrai reinserire la password.')) {
                sessionStorage.removeItem('bar_auth_session');
                ENCRYPTION_KEY = null;
                isAuthenticated = false;
                location.reload();
            }
        }

        // Override delle funzioni di storage per crittografare automaticamente
        const originalSetItem = localStorage.setItem.bind(localStorage);
        const originalGetItem = localStorage.getItem.bind(localStorage);

        localStorage.setItem = function(key, value) {
            if (key.startsWith('barManager_') && ENCRYPTION_KEY) {
                const encrypted = encryptData(value);
                return originalSetItem(key, encrypted);
            }
            return originalSetItem(key, value);
        };

        localStorage.getItem = function(key) {
            const value = originalGetItem(key);
            if (key.startsWith('barManager_') && value && ENCRYPTION_KEY) {
                const decrypted = decryptData(value);
                return decrypted;
            }
            return value;
        };

        // Inizializza app solo dopo autenticazione
        async function initializeApp() {
            // Il resto del codice dell'app parte da qui
            loadTheme();
            updateVersionDisplay(); // Mostra versione nella barra
            renderTasks();
            renderTransactions();
            updateFinanceStats();
            updateSummary();
            renderPlans();
            renderChecklist();
            renderCalendar();
            renderEvents();
            renderDeposits();
            renderGonfiabili();
            updateGonfiabiliStats();
            document.getElementById('filterAll').classList.add('filter-active');
            
            // Avvia controllo aggiornamenti
            startUpdateChecker();
        }

        // Avvia l'app
        window.addEventListener('DOMContentLoaded', async () => {
            const hasSession = await checkExistingSession();
            if (!hasSession) {
                showLoginScreen();
            } else {
                initializeApp();
            }
        });

        // Esponi tutte le funzioni necessarie globalmente
        window.deleteTask = deleteTask;
        window.deletePlan = deletePlan;
        window.deleteTransaction = deleteTransaction;
        window.deleteEvent = deleteEvent;
        window.openTaskModal = openTaskModal;
        window.closeTaskModal = closeTaskModal;
        window.saveTask = saveTask;
        window.openTransactionModal = openTransactionModal;
        window.closeTransactionModal = closeTransactionModal;
        window.saveTransaction = saveTransaction;
        window.openPlanModal = openPlanModal;
        window.closePlanModal = closePlanModal;
        window.savePlan = savePlan;
        window.openEventModal = openEventModal;
        window.closeEventModal = closeEventModal;
        window.saveEvent = saveEvent;
        window.filterPlans = filterPlans;
        window.filterTransactionsByPeriod = filterTransactionsByPeriod;
        window.switchFinanceView = switchFinanceView;
        window.filterEvents = filterEvents;
        window.addToChecklistFromPlan = addToChecklistFromPlan;
        window.toggleChecklistItem = toggleChecklistItem;
        window.resetChecklist = resetChecklist;
        window.previousMonth = previousMonth;
        window.nextMonth = nextMonth;
        window.goToToday = goToToday;
        window.selectDay = selectDay;
        window.closeSelectedDay = closeSelectedDay;
        window.toggleTheme = toggleTheme;
        window.logout = logout;
        window.toggleDepositFields = toggleDepositFields;
        window.toggleDepositsSection = toggleDepositsSection;
        window.addEventExpense = addEventExpense;
        window.removeEventExpense = removeEventExpense;
        window.updateEventExpense = updateEventExpense;
        window.applyUpdate = applyUpdate;
        window.openGonfiabileModal = openGonfiabileModal;
        window.closeGonfiabileModal = closeGonfiabileModal;
        window.saveGonfiabile = saveGonfiabile;
        window.deleteGonfiabile = deleteGonfiabile;
        window.filterGonfiabili = filterGonfiabili;
        window.calcolaGuadagnoGonfiabile = calcolaGuadagnoGonfiabile;
        window.manualCheckUpdate = manualCheckUpdate;
        window.openBudgetCategoryModal = openBudgetCategoryModal;
        window.closeBudgetCategoryModal = closeBudgetCategoryModal;
        window.saveBudgetCategory = saveBudgetCategory;
        window.deleteBudgetCategory = deleteBudgetCategory;
        window.changeNumbersMonth = changeNumbersMonth;
        window.previousBudgetMonth = previousBudgetMonth;
        window.nextBudgetMonth = nextBudgetMonth;
        window.addNewMonth = addNewMonth;

        // Previeni ispezione (opzionale, non sicuro al 100% ma scoraggia curiosi)
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('keydown', (e) => {
            // Blocca F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
                return false;
            }
        });

        // ========== CODICE PRINCIPALE APP (sotto autenticazione) ==========
        
        // Storage chiavi
        const STORAGE_KEYS = {
            TASKS: 'barManager_tasks',
            TRANSACTIONS: 'barManager_transactions',
            PLANS: 'barManager_plans',
            CHECKLIST: 'barManager_checklist',
            EVENTS: 'barManager_events',
            BUDGET_DATA: 'barManager_budgetData',
            BUDGET_MONTHS: 'barManager_budgetMonths',
            GONFIABILI: 'barManager_gonfiabili'
        };

        // Inizializza dati
        let tasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.TASKS) || '[]');
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
        let plans = JSON.parse(localStorage.getItem(STORAGE_KEYS.PLANS) || '[]');
        let checklist = JSON.parse(localStorage.getItem(STORAGE_KEYS.CHECKLIST) || '[]');
        let events = JSON.parse(localStorage.getItem(STORAGE_KEYS.EVENTS) || '[]');
        let gonfiabili = JSON.parse(localStorage.getItem(STORAGE_KEYS.GONFIABILI) || '[]');
        let currentGonfiabiliFilter = 'all';
        let editingGonfiabileId = null;
        
        // Budget data per mese
        let budgetData = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUDGET_DATA) || '{}');
        let budgetMonths = JSON.parse(localStorage.getItem(STORAGE_KEYS.BUDGET_MONTHS) || '["2025-10"]');
        let currentBudgetMonth = '2025-10'; // Ottobre 2025 come default
        
        // Inizializza dati Ottobre 2025 se non esistono
        if (!budgetData['2025-10']) {
            budgetData['2025-10'] = [
                { id: 1, name: 'SPESE FISSE', budget: 144140, spese: 142640, color: '#FF6B6B' },
                { id: 2, name: 'PANE', budget: 144140, spese: 1200, color: '#4ECDC4' },
                { id: 3, name: 'VIGILANZA', budget: 144140, spese: 90, color: '#45B7D1' },
                { id: 4, name: 'COMUNICAZIONE', budget: 144140, spese: 2200, color: '#FFA07A' },
                { id: 5, name: 'PROGRAMMA', budget: 144140, spese: 100, color: '#98D8C8' },
                { id: 6, name: 'ACQUA', budget: 144140, spese: 1000, color: '#F7DC6F' },
                { id: 7, name: 'LUCE', budget: 144140, spese: 2000, color: '#BB8FCE' },
                { id: 8, name: 'DIFFERENTI', budget: 144140, spese: 2000, color: '#85C1E2' },
                { id: 9, name: 'EXTRA', budget: 144140, spese: 0, color: '#FFB6C1' },
                { id: 10, name: 'MAMMA', budget: 144140, spese: 19200, color: '#DDA0DD' },
                { id: 11, name: 'SPESE VARIABILI', budget: 144140, spese: 142, color: '#F4A460' },
                { id: 12, name: 'GIANPAOLO', budget: 144140, spese: 610, color: '#87CEEB' },
                { id: 13, name: 'SPESE OCCASIONALI', budget: 144140, spese: 610, color: '#98FB98' },
                { id: 14, name: 'ICCA', budget: 144140, spese: 1210, color: '#DEB887' },
                { id: 15, name: 'AD DISTRIBUZIONI', budget: 144140, spese: 1210, color: '#BC8F8F' },
                { id: 16, name: 'CASH', budget: 144140, spese: 3272.76, color: '#CD853F' },
                { id: 17, name: 'META', budget: 144140, spese: 1300, color: '#D8BFD8' },
                { id: 18, name: 'TAXI', budget: 144140, spese: 0, color: '#B0E0E6' },
                { id: 19, name: 'GIANITTO', budget: 144140, spese: 14700, color: '#FFDAB9' },
                { id: 20, name: 'SPOSA LECCE', budget: 144140, spese: 800, color: '#E6E6FA' },
                { id: 21, name: 'MR FOODY', budget: 144140, spese: 2829.97, color: '#FFF0F5' },
                { id: 22, name: 'FINANZE', budget: 144140, spese: 1070.17, color: '#F0E68C' },
                { id: 23, name: 'GIACOMO', budget: 144140, spese: 817.91, color: '#E0FFFF' },
                { id: 24, name: 'RISCOSSIONE', budget: 144140, spese: 27.66, color: '#FFFACD' },
                { id: 25, name: 'SAN CARLO', budget: 144140, spese: 321.91, color: '#FFE4B5' },
                { id: 26, name: 'NAZARIO', budget: 144140, spese: 2200, color: '#FAEBD7' },
                { id: 27, name: 'TASSE', budget: 144140, spese: 1030, color: '#D3D3D3' },
                { id: 28, name: 'OLIO', budget: 144140, spese: 75, color: '#FFDEAD' },
                { id: 29, name: 'VITO', budget: 144140, spese: 0, color: '#FFE4E1' },
                { id: 30, name: 'PET FOOD', budget: 144140, spese: 700, color: '#F5F5DC' },
                { id: 31, name: 'BISCUIT', budget: 144140, spese: 3244.04, color: '#FFF5EE' }
            ];
            localStorage.setItem(STORAGE_KEYS.BUDGET_DATA, JSON.stringify(budgetData));
            localStorage.setItem(STORAGE_KEYS.BUDGET_MONTHS, JSON.stringify(budgetMonths));
        }
        
        let budgetCategories = budgetData[currentBudgetMonth] || [];
        
        let currentPlanFilter = 'all';
        let currentTransactionPeriod = 'all';
        let currentFinanceView = 'all';
        let currentEventFilter = 'all';
        let editingTransactionId = null;
        let editingEventId = null;
        let editingBudgetCategoryId = null;
        let numbersChart = null;

        // Navigazione
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const section = item.dataset.section;
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                
                if (section === 'riepilogo') {
                    updateSummary();
                }
            });
        });

        // Modal Impegni
        function openTaskModal() {
            document.getElementById('taskModal').classList.add('active');
            document.getElementById('taskDate').valueAsDate = new Date();
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            clearTaskForm();
        }

        function clearTaskForm() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDate').value = '';
            document.getElementById('taskTime').value = '';
            document.getElementById('taskType').value = 'personale';
            document.getElementById('taskNotes').value = '';
        }

        function saveTask() {
            const task = {
                id: Date.now(),
                title: document.getElementById('taskTitle').value,
                date: document.getElementById('taskDate').value,
                time: document.getElementById('taskTime').value,
                type: document.getElementById('taskType').value,
                notes: document.getElementById('taskNotes').value
            };

            if (!task.title || !task.date) {
                alert('Inserisci almeno titolo e data');
                return;
            }

            tasks.push(task);
            localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
            closeTaskModal();
            renderTasks();
            renderCalendar();
        }

        function deleteTask(id) {
            if (confirm('Sei sicuro di voler eliminare questo impegno?')) {
                tasks = tasks.filter(t => t.id !== id);
                localStorage.setItem(STORAGE_KEYS.TASKS, JSON.stringify(tasks));
                renderTasks();
                renderCalendar();
                
                // Refresh selected day if open
                if (selectedDate) {
                    selectDay(selectedDate);
                }
            }
        }

        function renderTasks() {
            const container = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Nessun impegno registrato</div>
                    </div>
                `;
                return;
            }

            const sortedTasks = tasks.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                return dateA - dateB;
            });

            container.innerHTML = sortedTasks.map(task => {
                const date = new Date(task.date).toLocaleDateString('it-IT', { 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                });
                const typeLabel = task.type === 'personale' ? 'Personale' : 'Attivit√†';
                
                return `
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-title">
                                ${task.title}
                                <span class="badge ${task.type}">${typeLabel}</span>
                            </div>
                            <div class="task-meta">
                                ${date}${task.time ? ' ‚Ä¢ ' + task.time : ''}
                                ${task.notes ? ' ‚Ä¢ ' + task.notes : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="icon-btn" onclick="deleteTask(${task.id})" title="Elimina">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal Transazioni
        function toggleDepositFields() {
            const type = document.getElementById('transactionType').value;
            const depositFields = document.getElementById('depositFields');
            
            if (type === 'deposit') {
                depositFields.style.display = 'block';
                // I versamenti sono sempre uscite dal bar (soldi che escono dalla cassa)
                document.getElementById('transactionCategory').value = 'business';
            } else {
                depositFields.style.display = 'none';
            }
        }

        function openTransactionModal(transactionId = null) {
            editingTransactionId = transactionId;
            
            if (transactionId) {
                // Modalit√† modifica
                const transaction = transactions.find(t => t.id === transactionId);
                if (transaction) {
                    document.getElementById('transactionType').value = transaction.type;
                    document.getElementById('transactionCategory').value = transaction.category || 'business';
                    document.getElementById('transactionAmount').value = transaction.amount;
                    document.getElementById('transactionDesc').value = transaction.description;
                    document.getElementById('transactionDate').value = transaction.date;
                    document.getElementById('transactionNotes').value = transaction.notes || '';
                    
                    // Campi versamento
                    if (transaction.type === 'deposit') {
                        document.getElementById('depositType').value = transaction.depositType || 'bank';
                        document.getElementById('depositDestination').value = transaction.depositDestination || '';
                    }
                    
                    toggleDepositFields();
                    document.querySelector('#transactionModal .modal-title').textContent = 'Modifica Movimento';
                }
            } else {
                // Modalit√† nuovo
                document.querySelector('#transactionModal .modal-title').textContent = 'Nuovo Movimento';
                document.getElementById('transactionDate').valueAsDate = new Date();
                toggleDepositFields();
            }
            
            document.getElementById('transactionModal').classList.add('active');
        }

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            editingTransactionId = null;
            clearTransactionForm();
        }

        function clearTransactionForm() {
            document.getElementById('transactionType').value = 'income';
            document.getElementById('transactionCategory').value = 'business';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionDesc').value = '';
            document.getElementById('transactionDate').value = '';
            document.getElementById('transactionNotes').value = '';
        }

        function saveTransaction() {
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDesc').value;
            const date = document.getElementById('transactionDate').value;
            const type = document.getElementById('transactionType').value;

            if (!amount || !description || !date) {
                alert('Compila tutti i campi obbligatori');
                return;
            }

            const transactionData = {
                type: type,
                category: document.getElementById('transactionCategory').value,
                amount: amount,
                description: description,
                date: date,
                notes: document.getElementById('transactionNotes').value
            };

            // Aggiungi campi specifici per versamenti
            if (type === 'deposit') {
                transactionData.depositType = document.getElementById('depositType').value;
                transactionData.depositDestination = document.getElementById('depositDestination').value;
            }

            if (editingTransactionId) {
                // Modifica esistente
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    transactions[index] = {
                        ...transactions[index],
                        ...transactionData
                    };
                }
            } else {
                // Nuovo movimento
                const transaction = {
                    id: Date.now(),
                    ...transactionData
                };
                transactions.push(transaction);
            }

            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
            closeTransactionModal();
            renderTransactions();
            updateFinanceStats();
            renderDeposits();
        }

        function deleteTransaction(id) {
            if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
                renderTransactions();
                updateFinanceStats();
                renderDeposits();
            }
        }

        function toggleDepositsSection() {
            const card = document.getElementById('depositsCard');
            const btn = document.getElementById('toggleDepositsBtn');
            
            if (card.style.display === 'none') {
                card.style.display = 'block';
                btn.innerHTML = 'üí∞ Nascondi Versamenti (<span id="depositsCount">' + 
                    transactions.filter(t => t.type === 'deposit').length + '</span>)';
                renderDeposits();
            } else {
                card.style.display = 'none';
                btn.innerHTML = 'üí∞ Mostra Versamenti (<span id="depositsCount">' + 
                    transactions.filter(t => t.type === 'deposit').length + '</span>)';
            }
        }

        function renderDeposits() {
            const container = document.getElementById('depositsList');
            const deposits = transactions.filter(t => t.type === 'deposit');
            
            // Aggiorna contatore
            const counters = document.querySelectorAll('#depositsCount');
            counters.forEach(c => c.textContent = deposits.length);
            
            if (deposits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-text">Nessun versamento registrato</div>
                    </div>
                `;
                return;
            }

            const sortedDeposits = deposits.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            const depositTypeIcons = {
                'bank': 'üè¶',
                'cash': 'üíµ',
                'safe': 'üîí',
                'owner': 'üë§'
            };

            const depositTypeLabels = {
                'bank': 'Banca',
                'cash': 'Contanti',
                'safe': 'Cassaforte',
                'owner': 'Proprietario'
            };

            container.innerHTML = sortedDeposits.map(deposit => {
                const date = new Date(deposit.date).toLocaleDateString('it-IT', { 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                });
                const icon = depositTypeIcons[deposit.depositType] || 'üí∞';
                const typeLabel = depositTypeLabels[deposit.depositType] || 'Versamento';
                
                return `
                    <div class="transaction-day-item" style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 16px;
                        background: var(--card-bg);
                        border-radius: 10px;
                        margin-bottom: 12px;
                        border-left: 4px solid #f093fb;
                        transition: all 0.2s;
                    ">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="font-size: 32px;">${icon}</div>
                                <div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">
                                        ${deposit.description}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${date} ‚Ä¢ ${typeLabel}
                                        ${deposit.depositDestination ? ' ‚Ä¢ ' + deposit.depositDestination : ''}
                                    </div>
                                </div>
                            </div>
                            ${deposit.notes ? `
                                <div style="font-size: 14px; color: var(--text-secondary); margin-left: 44px;">
                                    üìù ${deposit.notes}
                                </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 20px; font-weight: 700; color: #f093fb;">
                                ‚Ç¨${deposit.amount.toFixed(2)}
                            </div>
                            <button class="btn btn-secondary btn-edit-transaction" data-id="${deposit.id}" style="padding: 8px 12px;">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-delete-transaction" data-id="${deposit.id}" style="padding: 8px 12px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners
            setTimeout(() => {
                document.querySelectorAll('.btn-edit-transaction').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = parseInt(this.getAttribute('data-id'));
                        openTransactionModal(id);
                    });
                });
                
                document.querySelectorAll('.btn-delete-transaction').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = parseInt(this.getAttribute('data-id'));
                        if (confirm('Sei sicuro di voler eliminare questo versamento?')) {
                            transactions = transactions.filter(t => t.id !== id);
                            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
                            renderTransactions();
                            updateFinanceStats();
                            renderDeposits();
                        }
                    });
                });
            }, 0);
        }

        function switchFinanceView(view) {
            currentFinanceView = view;
            
            // Update button states
            document.querySelectorAll('#financeViewAll, #financeViewBusiness, #financeViewPersonal').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            
            const buttonMap = {
                'all': 'financeViewAll',
                'business': 'financeViewBusiness',
                'personal': 'financeViewPersonal'
            };
            
            document.getElementById(buttonMap[view]).classList.add('filter-active');
            
            // Update labels
            const labels = {
                'all': { income: 'Entrate Totali', expense: 'Uscite Totali', balance: 'Bilancio' },
                'business': { income: 'Entrate Attivit√†', expense: 'Uscite Attivit√†', balance: 'Bilancio Attivit√†' },
                'personal': { income: 'Entrate Personali', expense: 'Uscite Personali', balance: 'Bilancio Personale' }
            };
            
            document.getElementById('incomeLabelText').textContent = labels[view].income;
            document.getElementById('expenseLabelText').textContent = labels[view].expense;
            document.getElementById('balanceLabelText').textContent = labels[view].balance;
            
            renderTransactions();
            updateFinanceStats();
        }

        function filterTransactionsByPeriod(period) {
            currentTransactionPeriod = period;
            
            // Update active button
            document.querySelectorAll('[id^="filter"][id*="Transaction"], #filterToday, #filterWeek, #filterMonth, #filterYear').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            
            const buttonMap = {
                'today': 'filterToday',
                'week': 'filterWeek',
                'month': 'filterMonth',
                'year': 'filterYear',
                'all': 'filterAllTransactions'
            };
            
            document.getElementById(buttonMap[period]).classList.add('filter-active');
            
            renderTransactions();
            updateFinanceStats();
        }

        function getFilteredTransactions() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return transactions.filter(tr => {
                const trDate = new Date(tr.date + 'T00:00:00');
                
                // Filter by category first
                const categoryMatch = currentFinanceView === 'all' || 
                                    (tr.category || 'business') === currentFinanceView;
                
                if (!categoryMatch) return false;
                
                // Then filter by period
                switch(currentTransactionPeriod) {
                    case 'today':
                        return trDate.toDateString() === today.toDateString();
                    
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return trDate >= weekAgo;
                    
                    case 'month':
                        return trDate.getMonth() === now.getMonth() && 
                               trDate.getFullYear() === now.getFullYear();
                    
                    case 'year':
                        return trDate.getFullYear() === now.getFullYear();
                    
                    case 'all':
                    default:
                        return true;
                }
            });
        }

        function renderTransactions() {
            const container = document.getElementById('transactionList');
            
            const filteredTransactions = getFilteredTransactions().filter(t => t.type !== 'deposit'); // Escludi versamenti
            
            if (filteredTransactions.length === 0) {
                let emptyMessage = 'Nessun movimento registrato';
                if (currentTransactionPeriod === 'today') emptyMessage = 'Nessun movimento oggi';
                else if (currentTransactionPeriod === 'week') emptyMessage = 'Nessun movimento questa settimana';
                else if (currentTransactionPeriod === 'month') emptyMessage = 'Nessun movimento questo mese';
                else if (currentTransactionPeriod === 'year') emptyMessage = 'Nessun movimento quest\'anno';
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div class="empty-state-text">${emptyMessage}</div>
                    </div>
                `;
                return;
            }

            const sortedTransactions = filteredTransactions.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            // Raggruppa per data
            const groupedByDate = {};
            sortedTransactions.forEach(tr => {
                if (!groupedByDate[tr.date]) {
                    groupedByDate[tr.date] = [];
                }
                groupedByDate[tr.date].push(tr);
            });

            let html = '';

            Object.keys(groupedByDate).forEach(date => {
                const dayTransactions = groupedByDate[date];
                
                // Calcola totali del giorno
                const dayIncome = dayTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                const dayExpense = dayTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                const dayBalance = dayIncome - dayExpense;

                // Header del giorno
                const dateObj = new Date(date + 'T00:00:00');
                const today = new Date().toDateString();
                const isToday = dateObj.toDateString() === today;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const isYesterday = dateObj.toDateString() === yesterday.toDateString();

                let dateLabel;
                if (isToday) {
                    dateLabel = 'Oggi';
                } else if (isYesterday) {
                    dateLabel = 'Ieri';
                } else {
                    dateLabel = dateObj.toLocaleDateString('it-IT', { 
                        weekday: 'long',
                        day: 'numeric', 
                        month: 'long',
                        year: 'numeric'
                    });
                    dateLabel = dateLabel.charAt(0).toUpperCase() + dateLabel.slice(1);
                }

                html += `
                    <div style="
                        background: var(--task-item-bg);
                        padding: 16px;
                        border-radius: 10px;
                        margin-bottom: 16px;
                        border-left: 4px solid ${dayBalance >= 0 ? '#34c759' : '#ff3b30'};
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                    ${dateLabel}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    ${dayTransactions.length} movimento${dayTransactions.length > 1 ? 'i' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">Bilancio giorno</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${dayBalance >= 0 ? '#34c759' : '#ff3b30'};">
                                    ${dayBalance >= 0 ? '+' : ''}‚Ç¨${dayBalance.toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 8px;">
                `;

                // Transazioni del giorno
                dayTransactions.forEach(tr => {
                    const amountClass = tr.type === 'income' ? 'income' : 'expense';
                    const amountPrefix = tr.type === 'income' ? '+' : '-';
                    const categoryBadge = (tr.category || 'business') === 'personal' ? 
                        '<span class="badge" style="background: #5856d6; color: white; margin-left: 8px;">üë§ Personale</span>' : 
                        '<span class="badge" style="background: #007aff; color: white; margin-left: 8px;">üíº Attivit√†</span>';
                    
                    html += `
                        <div class="transaction-day-item" style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 12px;
                            background: var(--card-bg);
                            border-radius: 8px;
                            transition: all 0.2s;
                        ">
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">
                                    ${tr.description}
                                    ${categoryBadge}
                                </div>
                                ${tr.notes ? `<div style="font-size: 13px; color: var(--text-secondary);">${tr.notes}</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="transaction-amount ${amountClass}">
                                    ${amountPrefix}‚Ç¨${tr.amount.toFixed(2)}
                                </div>
                                <button class="icon-btn btn-edit-transaction" data-id="${tr.id}" title="Modifica">‚úèÔ∏è</button>
                                <button class="icon-btn btn-delete-transaction" data-id="${tr.id}" title="Elimina">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                        
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 12px;
                            margin-top: 12px;
                            padding-top: 12px;
                            border-top: 1px solid var(--card-border);
                        ">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Entrate</div>
                                <div style="font-size: 14px; font-weight: 600; color: #34c759;">+‚Ç¨${dayIncome.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Uscite</div>
                                <div style="font-size: 14px; font-weight: 600; color: #ff3b30;">-‚Ç¨${dayExpense.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Aggiungi event listeners per i pulsanti
            setTimeout(() => {
                document.querySelectorAll('.btn-edit-transaction').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = parseInt(this.getAttribute('data-id'));
                        openTransactionModal(id);
                    });
                });
                
                document.querySelectorAll('.btn-delete-transaction').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = parseInt(this.getAttribute('data-id'));
                        if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                            transactions = transactions.filter(t => t.id !== id);
                            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
                            renderTransactions();
                            updateFinanceStats();
                        }
                    });
                });
            }, 0);
        }

        function updateFinanceStats() {
            const filteredTransactions = getFilteredTransactions();
            
            const income = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const deposits = filteredTransactions
                .filter(t => t.type === 'deposit')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = income - expense;

            document.getElementById('totalIncome').textContent = '‚Ç¨' + income.toFixed(2);
            document.getElementById('totalExpense').textContent = '‚Ç¨' + expense.toFixed(2);
            document.getElementById('balance').textContent = '‚Ç¨' + balance.toFixed(2);
            document.getElementById('totalDeposits').textContent = '‚Ç¨' + deposits.toFixed(2);
        }

        function updateSummary() {
            // Impegni
            const totalTasks = tasks.length;
            const personalTasks = tasks.filter(t => t.type === 'personale').length;
            
            document.getElementById('summaryTasksTotal').textContent = totalTasks;
            document.getElementById('summaryTasksPersonal').textContent = personalTasks;

            // Eventi
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const totalEvents = events.length;
            const upcomingEvents = events.filter(e => {
                const eventDate = new Date(e.date + 'T00:00:00');
                return eventDate >= today;
            }).length;
            const totalEventBudget = events.reduce((sum, e) => sum + (e.budget || 0), 0);
            
            document.getElementById('summaryEventsTotal').textContent = totalEvents;
            document.getElementById('summaryEventsUpcoming').textContent = upcomingEvents;
            document.getElementById('summaryEventsBudget').textContent = '‚Ç¨' + totalEventBudget.toFixed(2);

            // Finanze
            const income = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const deposits = transactions
                .filter(t => t.type === 'deposit')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = income - expense;

            document.getElementById('summaryIncome').textContent = '‚Ç¨' + income.toFixed(2);
            document.getElementById('summaryExpense').textContent = '‚Ç¨' + expense.toFixed(2);
            document.getElementById('summaryBalance').textContent = '‚Ç¨' + balance.toFixed(2);
            document.getElementById('summaryDeposits').textContent = '‚Ç¨' + deposits.toFixed(2);

            // Ultimi Versamenti (top 5)
            const recentDeposits = transactions
                .filter(t => t.type === 'deposit')
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const depositsContainer = document.getElementById('summaryDepositsDetail');
            
            if (recentDeposits.length === 0) {
                depositsContainer.innerHTML = `
                    <div style="text-align: center; padding: 24px; color: var(--text-secondary); background: var(--task-item-bg); border-radius: 10px;">
                        Nessun versamento registrato
                    </div>
                `;
            } else {
                const depositTypeIcons = {
                    'bank': 'üè¶',
                    'cash': 'üíµ',
                    'safe': 'üîí',
                    'owner': 'üë§'
                };
                
                depositsContainer.innerHTML = recentDeposits.map(dep => {
                    const date = new Date(dep.date).toLocaleDateString('it-IT', { 
                        day: 'numeric', 
                        month: 'short'
                    });
                    const icon = depositTypeIcons[dep.depositType] || 'üí∞';
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--task-item-bg); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">${icon}</span>
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${dep.description}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${date}${dep.depositDestination ? ' ‚Ä¢ ' + dep.depositDestination : ''}</div>
                                </div>
                            </div>
                            <div style="font-size: 16px; font-weight: 700; color: #f093fb;">‚Ç¨${dep.amount.toFixed(2)}</div>
                        </div>
                    `;
                }).join('');
            }

            // Programmazione (gi√† esistente)
            const totalPlans = plans.length;
            const completedToday = checklist.filter(item => item.completed).length;
            const totalToday = checklist.length;
            const progressPercent = totalToday > 0 ? Math.round((completedToday / totalToday) * 100) : 0;
            
            if (document.getElementById('summaryPlansTotal')) {
                document.getElementById('summaryPlansTotal').textContent = totalPlans;
            }
            if (document.getElementById('summaryChecklistProgress')) {
                document.getElementById('summaryChecklistProgress').textContent = progressPercent + '%';
            }
        }

        // Chiudi modal cliccando fuori
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ========== PROGRAMMAZIONE ==========
        function openPlanModal() {
            document.getElementById('planModal').classList.add('active');
        }

        function closePlanModal() {
            document.getElementById('planModal').classList.remove('active');
            clearPlanForm();
        }

        function clearPlanForm() {
            document.getElementById('planTitle').value = '';
            document.getElementById('planCategory').value = 'pulizia';
            document.getElementById('planFrequency').value = 'giornaliera';
            document.getElementById('planPriority').value = 'media';
            document.getElementById('planDescription').value = '';
            document.getElementById('planAddToChecklist').checked = false;
        }

        function savePlan() {
            const plan = {
                id: Date.now(),
                title: document.getElementById('planTitle').value,
                category: document.getElementById('planCategory').value,
                frequency: document.getElementById('planFrequency').value,
                priority: document.getElementById('planPriority').value,
                description: document.getElementById('planDescription').value,
                addToChecklist: document.getElementById('planAddToChecklist').checked,
                createdAt: new Date().toISOString()
            };

            if (!plan.title) {
                alert('Inserisci almeno il titolo dell\'attivit√†');
                return;
            }

            plans.push(plan);
            localStorage.setItem(STORAGE_KEYS.PLANS, JSON.stringify(plans));
            
            if (plan.addToChecklist) {
                addToChecklist(plan);
            }
            
            closePlanModal();
            renderPlans();
        }

        function deletePlan(id) {
            if (confirm('Sei sicuro di voler eliminare questa attivit√† programmata?')) {
                plans = plans.filter(p => p.id !== id);
                localStorage.setItem(STORAGE_KEYS.PLANS, JSON.stringify(plans));
                renderPlans();
            }
        }

        function filterPlans(filter) {
            currentPlanFilter = filter;
            
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('filter-active');
            
            renderPlans();
        }

        function renderPlans() {
            const container = document.getElementById('planList');
            
            let filteredPlans = plans;
            if (currentPlanFilter !== 'all') {
                filteredPlans = plans.filter(p => p.frequency === currentPlanFilter);
            }

            if (filteredPlans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Nessuna attivit√† programmata</div>
                    </div>
                `;
                return;
            }

            const categoryEmojis = {
                'pulizia': 'üßπ',
                'scorte': 'üì¶',
                'fornitori': 'üöö',
                'personale': 'üë•',
                'manutenzione': 'üîß',
                'amministrazione': 'üìÑ',
                'marketing': 'üì±',
                'altro': '‚ú®'
            };

            const frequencyLabels = {
                'giornaliera': 'Giornaliera',
                'settimanale': 'Settimanale',
                'mensile': 'Mensile',
                'unica': 'Una tantum'
            };

            const priorityLabels = {
                'alta': 'Priorit√† Alta',
                'media': 'Priorit√† Media',
                'bassa': 'Priorit√† Bassa'
            };

            container.innerHTML = filteredPlans.map(plan => {
                const categoryEmoji = categoryEmojis[plan.category] || '‚ú®';
                const categoryName = document.getElementById('planCategory').querySelector(`option[value="${plan.category}"]`).textContent.replace(/^.+\s/, '');
                
                return `
                    <div class="plan-item">
                        <div class="plan-header">
                            <div class="plan-title-section">
                                <div class="plan-title">${categoryEmoji} ${plan.title}</div>
                                <div class="plan-badges">
                                    <span class="badge frequency">${frequencyLabels[plan.frequency]}</span>
                                    <span class="badge priority-${plan.priority}">${priorityLabels[plan.priority]}</span>
                                    <span class="badge" style="background: #5856d6; color: white;">${categoryName}</span>
                                    ${plan.addToChecklist ? '<span class="badge" style="background: #34c759; color: white;">‚úì Checklist</span>' : ''}
                                </div>
                                ${plan.description ? `<div class="plan-description">${plan.description}</div>` : ''}
                            </div>
                            <div class="plan-actions">
                                ${!plan.addToChecklist ? `<button class="icon-btn" onclick="addToChecklistFromPlan(${plan.id})" title="Aggiungi a checklist">‚úì</button>` : ''}
                                <button class="icon-btn" onclick="deletePlan(${plan.id})" title="Elimina">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== CHECKLIST GIORNALIERA ==========
        function addToChecklist(plan) {
            const checkItem = {
                id: Date.now(),
                planId: plan.id,
                title: plan.title,
                category: plan.category,
                completed: false,
                date: new Date().toDateString()
            };

            checklist.push(checkItem);
            localStorage.setItem(STORAGE_KEYS.CHECKLIST, JSON.stringify(checklist));
            renderChecklist();
        }

        function addToChecklistFromPlan(planId) {
            const plan = plans.find(p => p.id === planId);
            if (plan) {
                addToChecklist(plan);
                plan.addToChecklist = true;
                localStorage.setItem(STORAGE_KEYS.PLANS, JSON.stringify(plans));
                renderPlans();
            }
        }

        function toggleChecklistItem(id) {
            const item = checklist.find(c => c.id === id);
            if (item) {
                item.completed = !item.completed;
                localStorage.setItem(STORAGE_KEYS.CHECKLIST, JSON.stringify(checklist));
                renderChecklist();
            }
        }

        function resetChecklist() {
            if (confirm('Vuoi resettare la checklist giornaliera? Gli elementi completati verranno rimossi.')) {
                checklist = checklist.filter(c => !c.completed);
                localStorage.setItem(STORAGE_KEYS.CHECKLIST, JSON.stringify(checklist));
                renderChecklist();
            }
        }

        function renderChecklist() {
            const container = document.getElementById('dailyChecklist');
            
            const today = new Date().toDateString();
            const todayItems = checklist.filter(c => c.date === today);

            if (todayItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div class="empty-state-text">Nessuna attivit√† nella checklist di oggi</div>
                    </div>
                `;
                return;
            }

            const categoryEmojis = {
                'pulizia': 'üßπ',
                'scorte': 'üì¶',
                'fornitori': 'üöö',
                'personale': 'üë•',
                'manutenzione': 'üîß',
                'amministrazione': 'üìÑ',
                'marketing': 'üì±',
                'altro': '‚ú®'
            };

            const completed = todayItems.filter(c => c.completed).length;
            const total = todayItems.length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

            let html = `
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">Progresso</div>
                        <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">${completed}/${total} completate (${progress}%)</div>
                    </div>
                    <button class="btn btn-secondary" onclick="resetChecklist()">Reset Checklist</button>
                </div>
            `;

            html += todayItems.map(item => {
                const emoji = categoryEmojis[item.category] || '‚ú®';
                return `
                    <div class="checkbox-item ${item.completed ? 'completed' : ''}" onclick="toggleChecklistItem(${item.id})">
                        <div class="custom-checkbox"></div>
                        <div class="checkbox-label">${emoji} ${item.title}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ========== GESTIONE NUMBERS (BUDGET) ==========
        
        function initializeMonthSelector() {
            const select = document.getElementById('numbersMonthSelect');
            const monthNames = {
                '01': 'Gennaio', '02': 'Febbraio', '03': 'Marzo', '04': 'Aprile',
                '05': 'Maggio', '06': 'Giugno', '07': 'Luglio', '08': 'Agosto',
                '09': 'Settembre', '10': 'Ottobre', '11': 'Novembre', '12': 'Dicembre'
            };
            
            // Ordina mesi (pi√π recenti prima)
            const sortedMonths = [...budgetMonths].sort().reverse();
            
            select.innerHTML = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[monthNum];
                return `<option value="${month}">${monthName} ${year}</option>`;
            }).join('');
            
            select.value = currentBudgetMonth;
        }

        function changeNumbersMonth() {
            const select = document.getElementById('numbersMonthSelect');
            currentBudgetMonth = select.value;
            budgetCategories = budgetData[currentBudgetMonth] || [];
            renderBudgetCategories();
        }

        function previousBudgetMonth() {
            const currentIndex = budgetMonths.indexOf(currentBudgetMonth);
            if (currentIndex < budgetMonths.length - 1) {
                currentBudgetMonth = budgetMonths[currentIndex + 1];
                document.getElementById('numbersMonthSelect').value = currentBudgetMonth;
                budgetCategories = budgetData[currentBudgetMonth] || [];
                renderBudgetCategories();
            }
        }

        function nextBudgetMonth() {
            const currentIndex = budgetMonths.indexOf(currentBudgetMonth);
            if (currentIndex > 0) {
                currentBudgetMonth = budgetMonths[currentIndex - 1];
                document.getElementById('numbersMonthSelect').value = currentBudgetMonth;
                budgetCategories = budgetData[currentBudgetMonth] || [];
                renderBudgetCategories();
            }
        }

        function addNewMonth() {
            const monthName = prompt('Inserisci il mese nel formato YYYY-MM (es: 2026-02 per Febbraio 2026):');
            if (!monthName) return;
            
            // Valida formato
            const regex = /^\d{4}-(0[1-9]|1[0-2])$/;
            if (!regex.test(monthName)) {
                alert('Formato non valido! Usa YYYY-MM (es: 2026-02)');
                return;
            }
            
            if (budgetMonths.includes(monthName)) {
                alert('Questo mese esiste gi√†!');
                return;
            }
            
            // Copia categorie dal mese corrente (solo struttura, spese a 0)
            const currentCategories = budgetData[currentBudgetMonth] || [];
            budgetData[monthName] = currentCategories.map(cat => ({
                ...cat,
                id: Date.now() + Math.random(),
                spese: 0
            }));
            
            budgetMonths.push(monthName);
            budgetMonths.sort();
            
            localStorage.setItem(STORAGE_KEYS.BUDGET_DATA, JSON.stringify(budgetData));
            localStorage.setItem(STORAGE_KEYS.BUDGET_MONTHS, JSON.stringify(budgetMonths));
            
            currentBudgetMonth = monthName;
            budgetCategories = budgetData[currentBudgetMonth];
            
            initializeMonthSelector();
            renderBudgetCategories();
        }

        function openBudgetCategoryModal(categoryId = null) {
            editingBudgetCategoryId = categoryId;
            
            if (categoryId) {
                const category = budgetCategories.find(c => c.id === categoryId);
                if (category) {
                    document.getElementById('budgetCategoryName').value = category.name;
                    document.getElementById('budgetCategoryBudget').value = category.budget;
                    document.getElementById('budgetCategorySpese').value = category.spese;
                    document.getElementById('budgetCategoryColor').value = category.color;
                    
                    // Seleziona colore
                    document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('selected'));
                    document.querySelector(`.color-picker[data-color="${category.color}"]`)?.classList.add('selected');
                    
                    document.querySelector('#budgetCategoryModal .modal-title').textContent = 'Modifica Categoria';
                }
            } else {
                document.querySelector('#budgetCategoryModal .modal-title').textContent = 'Nuova Categoria Budget';
                // Seleziona primo colore di default
                document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('selected'));
                document.querySelector('.color-picker').classList.add('selected');
            }
            
            document.getElementById('budgetCategoryModal').classList.add('active');
        }

        function closeBudgetCategoryModal() {
            document.getElementById('budgetCategoryModal').classList.remove('active');
            editingBudgetCategoryId = null;
            clearBudgetCategoryForm();
        }

        function clearBudgetCategoryForm() {
            document.getElementById('budgetCategoryName').value = '';
            document.getElementById('budgetCategoryBudget').value = '';
            document.getElementById('budgetCategorySpese').value = '';
            document.getElementById('budgetCategoryColor').value = '#FF6B6B';
            document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('selected'));
        }

        function saveBudgetCategory() {
            const name = document.getElementById('budgetCategoryName').value;
            const budget = parseFloat(document.getElementById('budgetCategoryBudget').value) || 0;
            const spese = parseFloat(document.getElementById('budgetCategorySpese').value) || 0;
            const color = document.getElementById('budgetCategoryColor').value;

            if (!name) {
                alert('Inserisci il nome della categoria');
                return;
            }

            if (editingBudgetCategoryId) {
                const index = budgetCategories.findIndex(c => c.id === editingBudgetCategoryId);
                if (index !== -1) {
                    budgetCategories[index] = {
                        ...budgetCategories[index],
                        name,
                        budget,
                        spese,
                        color
                    };
                }
            } else {
                budgetCategories.push({
                    id: Date.now(),
                    name,
                    budget,
                    spese,
                    color
                });
            }

            // Salva nel mese corrente
            budgetData[currentBudgetMonth] = budgetCategories;
            localStorage.setItem(STORAGE_KEYS.BUDGET_DATA, JSON.stringify(budgetData));
            
            closeBudgetCategoryModal();
            renderBudgetCategories();
        }

        function deleteBudgetCategory(id) {
            if (confirm('Sei sicuro di voler eliminare questa categoria?')) {
                budgetCategories = budgetCategories.filter(c => c.id !== id);
                budgetData[currentBudgetMonth] = budgetCategories;
                localStorage.setItem(STORAGE_KEYS.BUDGET_DATA, JSON.stringify(budgetData));
                renderBudgetCategories();
            }
        }

        function renderBudgetCategories() {
            // DATI FISSI ESATTI dal documento BAR_OTTOBRE.numbers
            const numbersData = [
                { categoria: 'SPESE FISSE', budget: 144140, entrate: 142640, color: '#FF6B6B', tipo: 'header' },
                { categoria: 'PANE', budget: 144140, entrate: 1200, color: '#4ECDC4' },
                { categoria: 'VIGILANZA', budget: 144140, entrate: 90, color: '#45B7D1' },
                { categoria: 'COMUNICAZIONE', budget: 144140, entrate: 2200, color: '#FFA07A' },
                { categoria: 'PROGRAMMA', budget: 144140, entrate: 100, color: '#98D8C8' },
                { categoria: 'ACQUA', budget: 144140, entrate: 1000, color: '#F7DC6F' },
                { categoria: 'LUCE', budget: 144140, entrate: 2000, color: '#BB8FCE' },
                { categoria: 'DIFFERENTI', budget: 144140, entrate: 2000, color: '#85C1E2' },
                { categoria: 'EXTRA', budget: 144140, entrate: 0, color: '#FFB6C1' },
                { categoria: 'MAMMA', budget: 144140, entrate: 19200, color: '#DDA0DD' },
                { categoria: 'TAXI', budget: 144140, entrate: 0, color: '#F4A460' },
                { categoria: 'SPESE VARIABILI', budget: 144140, entrate: 0, color: '#FF6B6B', tipo: 'header' },
                { categoria: 'GIAN', budget: 144140, entrate: 142, color: '#87CEEB' },
                { categoria: 'GIANPAOLO', budget: 144140, entrate: 610, color: '#98FB98' },
                { categoria: 'SPESE OCCASIONALI', budget: 144140, entrate: 610, color: '#DEB887' },
                { categoria: 'ICCA', budget: 144140, entrate: 1210, color: '#BC8F8F' },
                { categoria: 'AD DISTRIBUZIONI', budget: 144140, entrate: 1210, color: '#CD853F' },
                { categoria: 'CASH', budget: 144140, entrate: 3272.76, color: '#D8BFD8' },
                { categoria: 'META', budget: 144140, entrate: 1300, color: '#B0E0E6' },
                { categoria: 'VITO', budget: 144140, entrate: 3043, color: '#FFDAB9' },
                { categoria: 'GIANITTO', budget: 144140, entrate: 14700, color: '#E6E6FA' },
                { categoria: 'SPOSA LECCE', budget: 144140, entrate: 800, color: '#FFF0F5' },
                { categoria: 'MR FOODY', budget: 144140, entrate: 2829.97, color: '#F0E68C' },
                { categoria: 'FINANZE', budget: 144140, entrate: 1070.17, color: '#E0FFFF' },
                { categoria: 'GIACOMO', budget: 144140, entrate: 817.91, color: '#FFFACD' },
                { categoria: 'RISCOSSIONE', budget: 144140, entrate: 27.66, color: '#FFE4B5' },
                { categoria: 'SAN CARLO', budget: 144140, entrate: 321.91, color: '#FAEBD7' },
                { categoria: 'NAZARIO', budget: 144140, entrate: 2200, color: '#D3D3D3' },
                { categoria: 'TASSE', budget: 144140, entrate: 1030, color: '#FFDEAD' },
                { categoria: 'OLIO', budget: 144140, entrate: 75, color: '#FFE4E1' },
                { categoria: 'VITO', budget: 144140, entrate: 0, color: '#F5F5DC' },
                { categoria: 'PET FOOD', budget: 144140, entrate: 700, color: '#FFF5EE' },
                { categoria: 'BISCUIT', budget: 144140, entrate: 3244.04, color: '#FFE4C4' },
                { categoria: 'EMERGENZE', budget: 144140, entrate: 240.35, color: '#F0F8FF' }
            ];

            const container = document.getElementById('numbersTableBody');
            
            // Render tabella
            container.innerHTML = numbersData.map(item => {
                const differenza = item.budget - item.entrate;
                const rowClass = item.tipo === 'header' ? 'table-row header-row' : 'table-row';
                const formatEuro = (num) => num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
                
                return `
                    <div class="${rowClass}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; font-size: 13px; ${item.tipo === 'header' ? 'font-weight: 700; color: #ff3b30; background: #fff5f5;' : ''}">
                        <div style="font-weight: 500;">${item.categoria}</div>
                        <div style="text-align: right; font-variant-numeric: tabular-nums;">${formatEuro(item.budget)}</div>
                        <div style="text-align: right; font-variant-numeric: tabular-nums;">${formatEuro(item.entrate)}</div>
                        <div style="text-align: right; font-variant-numeric: tabular-nums;">${formatEuro(differenza)}</div>
                    </div>
                `;
            }).join('');

            // Render grafico
            renderNumbersChart(numbersData);
        }

        function updateNumbersStats() {
            const totalBudget = budgetCategories.reduce((sum, c) => sum + c.budget, 0);
            const totalSpese = budgetCategories.reduce((sum, c) => sum + c.spese, 0);
            const utile = totalBudget - totalSpese; // Budget (Fatturato) - Spese = Utile

            document.getElementById('numbersBudget').textContent = '‚Ç¨' + totalBudget.toFixed(2);
            document.getElementById('numbersSpese').textContent = '‚Ç¨' + totalSpese.toFixed(2);
            document.getElementById('numbersUtile').textContent = '‚Ç¨' + utile.toFixed(2);
            
            // Cambia colore card utile
            const utilCard = document.getElementById('numbersDifferenzaCard');
            if (utile >= 0) {
                utilCard.style.background = 'linear-gradient(135deg, #34c759 0%, #30d158 100%)';
            } else {
                utilCard.style.background = 'linear-gradient(135deg, #ff3b30 0%, #ff453a 100%)';
            }
        }

        function renderNumbersChart(numbersData) {
            const canvas = document.getElementById('numbersChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');

            // Distruggi chart esistente
            if (numbersChart) {
                numbersChart.destroy();
            }

            // Filtra solo voci con entrate > 0
            const dataForChart = numbersData.filter(item => item.entrate > 0);
            const totalEntrate = dataForChart.reduce((sum, item) => sum + item.entrate, 0);

            // Crea chart
            numbersChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataForChart.map(item => item.categoria),
                    datasets: [{
                        data: dataForChart.map(item => item.entrate),
                        backgroundColor: dataForChart.map(item => item.color),
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percent = ((value / totalEntrate) * 100).toFixed(1);
                                    const formatEuro = (num) => num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
                                    return `${context.label}: ${formatEuro(value)} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Render legenda
            const legendContainer = document.getElementById('numbersLegend');
            if (legendContainer) {
                legendContainer.innerHTML = dataForChart.map(item => {
                    const percentage = ((item.entrate / totalEntrate) * 100).toFixed(0);
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; margin-bottom: 4px; font-size: 11px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 10px; height: 10px; border-radius: 50%; background: ${item.color};"></div>
                                <span style="color: var(--text-primary);">${item.categoria}</span>
                            </div>
                            <span style="font-weight: 600; color: #86868b;">${percentage}%</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Color picker handler
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.color-picker').forEach(picker => {
                picker.addEventListener('click', function() {
                    document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('budgetCategoryColor').value = this.getAttribute('data-color');
                });
            });
        });

        // ========== GONFIABILI SERVICE ==========
        
        function openGonfiabileModal(id = null) {
            editingGonfiabileId = id;
            
            if (id) {
                const gonfiabile = gonfiabili.find(g => g.id === id);
                if (gonfiabile) {
                    document.getElementById('gonfiabileCliente').value = gonfiabile.cliente;
                    document.getElementById('gonfiabileTelefono').value = gonfiabile.telefono;
                    document.getElementById('gonfiabileIndirizzo').value = gonfiabile.indirizzo;
                    document.getElementById('gonfiabileDataUscita').value = gonfiabile.dataUscita;
                    document.getElementById('gonfiabileOraUscita').value = gonfiabile.oraUscita;
                    document.getElementById('gonfiabileDataRientro').value = gonfiabile.dataRientro;
                    document.getElementById('gonfiabileOraRientro').value = gonfiabile.oraRientro;
                    document.getElementById('gonfiabileTipo').value = gonfiabile.tipo;
                    document.getElementById('gonfiabileNome').value = gonfiabile.nome;
                    document.getElementById('gonfiabileIncasso').value = gonfiabile.incasso;
                    document.getElementById('gonfiabileCosti').value = gonfiabile.costi;
                    document.getElementById('gonfiabileStato').value = gonfiabile.stato;
                    document.getElementById('gonfiabileNote').value = gonfiabile.note || '';
                    calcolaGuadagnoGonfiabile();
                    document.querySelector('#gonfiabileModal .modal-title').textContent = 'Modifica Noleggio';
                }
            } else {
                document.querySelector('#gonfiabileModal .modal-title').textContent = 'Nuovo Noleggio Gonfiabile';
                document.getElementById('gonfiabileDataUscita').valueAsDate = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('gonfiabileDataRientro').valueAsDate = tomorrow;
            }
            
            document.getElementById('gonfiabileModal').classList.add('active');
        }

        function closeGonfiabileModal() {
            document.getElementById('gonfiabileModal').classList.remove('active');
            editingGonfiabileId = null;
            clearGonfiabileForm();
        }

        function clearGonfiabileForm() {
            document.getElementById('gonfiabileCliente').value = '';
            document.getElementById('gonfiabileTelefono').value = '';
            document.getElementById('gonfiabileIndirizzo').value = '';
            document.getElementById('gonfiabileDataUscita').value = '';
            document.getElementById('gonfiabileOraUscita').value = '09:00';
            document.getElementById('gonfiabileDataRientro').value = '';
            document.getElementById('gonfiabileOraRientro').value = '18:00';
            document.getElementById('gonfiabileTipo').value = 'castello';
            document.getElementById('gonfiabileNome').value = '';
            document.getElementById('gonfiabileIncasso').value = '';
            document.getElementById('gonfiabileCosti').value = '0';
            document.getElementById('gonfiabileStato').value = 'attivo';
            document.getElementById('gonfiabileNote').value = '';
            document.getElementById('gonfiabileGuadagnoCalc').textContent = '‚Ç¨0.00';
        }

        function calcolaGuadagnoGonfiabile() {
            const incasso = parseFloat(document.getElementById('gonfiabileIncasso').value) || 0;
            const costi = parseFloat(document.getElementById('gonfiabileCosti').value) || 0;
            const guadagno = incasso - costi;
            
            const calcEl = document.getElementById('gonfiabileGuadagnoCalc');
            calcEl.textContent = '‚Ç¨' + guadagno.toFixed(2);
            calcEl.style.color = guadagno >= 0 ? '#34c759' : '#ff3b30';
        }

        function saveGonfiabile() {
            const cliente = document.getElementById('gonfiabileCliente').value;
            const dataUscita = document.getElementById('gonfiabileDataUscita').value;
            const incasso = parseFloat(document.getElementById('gonfiabileIncasso').value) || 0;

            if (!cliente || !dataUscita) {
                alert('Compila almeno Cliente e Data Uscita');
                return;
            }

            const gonfiabile = {
                id: editingGonfiabileId || Date.now(),
                cliente: cliente,
                telefono: document.getElementById('gonfiabileTelefono').value,
                indirizzo: document.getElementById('gonfiabileIndirizzo').value,
                dataUscita: dataUscita,
                oraUscita: document.getElementById('gonfiabileOraUscita').value,
                dataRientro: document.getElementById('gonfiabileDataRientro').value,
                oraRientro: document.getElementById('gonfiabileOraRientro').value,
                tipo: document.getElementById('gonfiabileTipo').value,
                nome: document.getElementById('gonfiabileNome').value,
                incasso: incasso,
                costi: parseFloat(document.getElementById('gonfiabileCosti').value) || 0,
                guadagno: incasso - (parseFloat(document.getElementById('gonfiabileCosti').value) || 0),
                stato: document.getElementById('gonfiabileStato').value,
                note: document.getElementById('gonfiabileNote').value,
                createdAt: editingGonfiabileId ? gonfiabili.find(g => g.id === editingGonfiabileId).createdAt : new Date().toISOString()
            };

            if (editingGonfiabileId) {
                const index = gonfiabili.findIndex(g => g.id === editingGonfiabileId);
                gonfiabili[index] = gonfiabile;
            } else {
                gonfiabili.push(gonfiabile);
            }

            localStorage.setItem(STORAGE_KEYS.GONFIABILI, JSON.stringify(gonfiabili));
            closeGonfiabileModal();
            renderGonfiabili();
            updateGonfiabiliStats();
        }

        function deleteGonfiabile(id) {
            if (confirm('Eliminare questo noleggio?')) {
                gonfiabili = gonfiabili.filter(g => g.id !== id);
                localStorage.setItem(STORAGE_KEYS.GONFIABILI, JSON.stringify(gonfiabili));
                renderGonfiabili();
                updateGonfiabiliStats();
            }
        }

        function filterGonfiabili(filter) {
            currentGonfiabiliFilter = filter;
            
            document.querySelectorAll('#gonfiabili .filter-btn').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            
            if (filter === 'all') document.getElementById('filterAllGonfiabili').classList.add('filter-active');
            if (filter === 'attivi') document.getElementById('filterAttiviGonfiabili').classList.add('filter-active');
            if (filter === 'completati') document.getElementById('filterCompletatiGonfiabili').classList.add('filter-active');
            
            renderGonfiabili();
        }

        function renderGonfiabili() {
            const container = document.getElementById('gonfiabiliList');
            
            let filtered = gonfiabili;
            if (currentGonfiabiliFilter === 'attivi') {
                filtered = gonfiabili.filter(g => g.stato === 'attivo');
            } else if (currentGonfiabiliFilter === 'completati') {
                filtered = gonfiabili.filter(g => g.stato === 'completato');
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéà</div>
                        <div class="empty-state-text">Nessun noleggio</div>
                        <button class="btn" onclick="openGonfiabileModal()" style="margin-top: 16px;">Aggiungi Primo Noleggio</button>
                    </div>
                `;
                return;
            }

            // Ordina per data uscita (pi√π recenti prima)
            filtered.sort((a, b) => new Date(b.dataUscita) - new Date(a.dataUscita));

            const tipoEmoji = {
                castello: 'üè∞',
                scivolo: 'üé¢',
                percorso: 'üèÉ',
                calcio: '‚öΩ',
                piscina: 'üèä',
                toro: 'üêÇ',
                altro: '‚ú®'
            };

            const statoStyle = {
                attivo: { bg: '#34c75910', border: '#34c759', text: '#34c759', label: 'üü¢ In Corso' },
                completato: { bg: '#007aff10', border: '#007aff', text: '#007aff', label: '‚úÖ Completato' },
                annullato: { bg: '#ff3b3010', border: '#ff3b30', text: '#ff3b30', label: '‚ùå Annullato' }
            };

            container.innerHTML = filtered.map(g => {
                const stato = statoStyle[g.stato];
                const dataUscitaFormatted = new Date(g.dataUscita).toLocaleDateString('it-IT', { 
                    day: '2-digit', month: 'short', year: 'numeric'
                });
                const dataRientroFormatted = g.dataRientro ? new Date(g.dataRientro).toLocaleDateString('it-IT', { 
                    day: '2-digit', month: 'short'
                }) : 'Da definire';

                return `
                    <div class="transaction-item" style="border-left: 4px solid ${stato.border}; background: ${stato.bg};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 24px;">${tipoEmoji[g.tipo]}</span>
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${g.cliente}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">${g.nome || g.tipo}</div>
                                    </div>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                                    üìç ${g.indirizzo || 'Indirizzo non specificato'}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    üìû ${g.telefono || 'Tel. non specificato'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; color: ${stato.text}; background: ${stato.bg}; border: 1px solid ${stato.border}; margin-bottom: 8px;">
                                    ${stato.label}
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; padding: 12px; background: var(--card-bg); border-radius: 8px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">Uscita (Consegna)</div>
                                <div style="font-weight: 600; color: var(--text-primary);">üì§ ${dataUscitaFormatted} ‚Ä¢ ${g.oraUscita}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">Rientro (Ritiro)</div>
                                <div style="font-weight: 600; color: var(--text-primary);">üì• ${dataRientroFormatted} ‚Ä¢ ${g.oraRientro}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                            <div style="text-align: center; padding: 8px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-secondary);">Incasso</div>
                                <div style="font-weight: 700; color: #34c759; font-size: 15px;">‚Ç¨${g.incasso.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-secondary);">Costi</div>
                                <div style="font-weight: 700; color: #ff3b30; font-size: 15px;">‚Ç¨${g.costi.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-secondary);">Guadagno</div>
                                <div style="font-weight: 700; color: ${g.guadagno >= 0 ? '#007aff' : '#ff3b30'}; font-size: 15px;">‚Ç¨${g.guadagno.toFixed(2)}</div>
                            </div>
                        </div>

                        ${g.note ? `
                            <div style="padding: 8px; background: var(--card-bg); border-radius: 6px; font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                üìù ${g.note}
                            </div>
                        ` : ''}

                        <div class="transaction-actions">
                            <button class="icon-btn" onclick="openGonfiabileModal(${g.id})" title="Modifica">‚úèÔ∏è</button>
                            <button class="icon-btn" onclick="deleteGonfiabile(${g.id})" title="Elimina">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Event delegation per i pulsanti
            setTimeout(() => {
                container.querySelectorAll('.icon-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                });
            }, 0);
        }

        function updateGonfiabiliStats() {
            const totali = gonfiabili.length;
            const incasso = gonfiabili.reduce((sum, g) => sum + g.incasso, 0);
            const costi = gonfiabili.reduce((sum, g) => sum + g.costi, 0);
            const guadagno = incasso - costi;

            document.getElementById('gonfiabiliTotali').textContent = totali;
            document.getElementById('gonfiabiliIncasso').textContent = '‚Ç¨' + incasso.toFixed(2);
            document.getElementById('gonfiabiliCosti').textContent = '‚Ç¨' + costi.toFixed(2);
            document.getElementById('gonfiabiliGuadagno').textContent = '‚Ç¨' + guadagno.toFixed(2);
        }

        // ========== EVENTI ==========
        let currentEventExpenses = [];

        function addEventExpense() {
            const expense = {
                id: Date.now(),
                description: '',
                amount: 0
            };
            currentEventExpenses.push(expense);
            renderEventExpenses();
        }

        function removeEventExpense(id) {
            currentEventExpenses = currentEventExpenses.filter(e => e.id !== id);
            renderEventExpenses();
        }

        function updateEventExpense(id, field, value) {
            const expense = currentEventExpenses.find(e => e.id === id);
            if (expense) {
                expense[field] = field === 'amount' ? parseFloat(value) || 0 : value;
                renderEventExpenses();
            }
        }

        function renderEventExpenses() {
            const container = document.getElementById('eventExpensesList');
            
            if (currentEventExpenses.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 16px; color: var(--text-secondary); font-size: 13px;">
                        Nessuna spesa aggiunta
                    </div>
                `;
                return;
            }

            const totalExpenses = currentEventExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            let html = '';
            
            currentEventExpenses.forEach(expense => {
                html += `
                    <div class="event-expense-item">
                        <input type="text" 
                               placeholder="Descrizione (es: DJ, Luci, Bevande)" 
                               value="${expense.description}"
                               onchange="updateEventExpense(${expense.id}, 'description', this.value)">
                        <input type="number" 
                               placeholder="‚Ç¨ 0.00" 
                               step="0.01" 
                               min="0"
                               value="${expense.amount || ''}"
                               onchange="updateEventExpense(${expense.id}, 'amount', this.value)"
                               style="max-width: 120px;">
                        <button onclick="removeEventExpense(${expense.id})">üóëÔ∏è</button>
                    </div>
                `;
            });

            // Aggiungi totale spese
            html += `
                <div style="margin-top: 12px; padding: 12px; background: var(--task-item-bg); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: var(--text-primary);">Totale Spese:</span>
                    <span style="font-size: 18px; font-weight: 700; color: #ff3b30;">‚Ç¨${totalExpenses.toFixed(2)}</span>
                </div>
            `;

            // Verifica budget
            const budget = parseFloat(document.getElementById('eventBudget').value) || 0;
            if (budget > 0) {
                const remaining = budget - totalExpenses;
                const percentUsed = (totalExpenses / budget) * 100;
                
                if (remaining >= 0) {
                    html += `
                        <div class="budget-alert budget-ok" style="margin-top: 8px;">
                            ‚úÖ Budget OK ‚Ä¢ Rimanenti: ‚Ç¨${remaining.toFixed(2)} (${(100 - percentUsed).toFixed(0)}%)
                        </div>
                    `;
                } else {
                    html += `
                        <div class="budget-alert" style="margin-top: 8px;">
                            ‚ö†Ô∏è Sforamento Budget! ‚Ä¢ Oltre: ‚Ç¨${Math.abs(remaining).toFixed(2)} (${(percentUsed - 100).toFixed(0)}% sopra)
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        function openEventModal(eventId = null) {
            editingEventId = eventId;
            currentEventExpenses = [];
            
            if (eventId) {
                const event = events.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDate').value = event.date;
                    document.getElementById('eventTime').value = event.time || '';
                    document.getElementById('eventType').value = event.type;
                    document.getElementById('eventDescription').value = event.description || '';
                    document.getElementById('eventPrice').value = event.price || '';
                    document.getElementById('eventBudget').value = event.budget || '';
                    document.getElementById('eventLink').value = event.link || '';
                    document.getElementById('eventArtist').value = event.artist || '';
                    document.getElementById('eventIdeas').value = event.ideas || '';
                    document.getElementById('eventPublished').checked = event.published || false;
                    
                    // Carica spese
                    if (event.expenses && Array.isArray(event.expenses)) {
                        currentEventExpenses = [...event.expenses];
                    }
                    
                    document.querySelector('#eventModal .modal-title').textContent = 'Modifica Evento';
                }
            } else {
                document.querySelector('#eventModal .modal-title').textContent = 'Nuovo Evento';
                document.getElementById('eventDate').valueAsDate = new Date();
            }
            
            renderEventExpenses();
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            editingEventId = null;
            clearEventForm();
        }

        function clearEventForm() {
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventType').value = 'music';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventPrice').value = '';
            document.getElementById('eventMedia').value = '';
            document.getElementById('eventLink').value = '';
            document.getElementById('eventArtist').value = '';
            document.getElementById('eventIdeas').value = '';
            document.getElementById('eventPublished').checked = false;
        }

        async function saveEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;

            if (!title || !date) {
                alert('Inserisci almeno titolo e data dell\'evento');
                return;
            }

            // Handle media files
            const mediaFiles = document.getElementById('eventMedia').files;
            const mediaArray = [];
            
            for (let file of mediaFiles) {
                const reader = new FileReader();
                const mediaData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve({
                        name: file.name,
                        type: file.type,
                        data: e.target.result
                    });
                    reader.readAsDataURL(file);
                });
                mediaArray.push(mediaData);
            }

            if (editingEventId) {
                // Modifica esistente
                const index = events.findIndex(e => e.id === editingEventId);
                if (index !== -1) {
                    events[index] = {
                        ...events[index],
                        title: title,
                        date: date,
                        time: document.getElementById('eventTime').value,
                        type: document.getElementById('eventType').value,
                        description: document.getElementById('eventDescription').value,
                        price: parseFloat(document.getElementById('eventPrice').value) || 0,
                        budget: parseFloat(document.getElementById('eventBudget').value) || 0,
                        expenses: [...currentEventExpenses],
                        media: mediaArray.length > 0 ? mediaArray : events[index].media,
                        link: document.getElementById('eventLink').value,
                        artist: document.getElementById('eventArtist').value,
                        ideas: document.getElementById('eventIdeas').value,
                        published: document.getElementById('eventPublished').checked
                    };
                }
            } else {
                // Nuovo evento
                const event = {
                    id: Date.now(),
                    title: title,
                    date: date,
                    time: document.getElementById('eventTime').value,
                    type: document.getElementById('eventType').value,
                    description: document.getElementById('eventDescription').value,
                    price: parseFloat(document.getElementById('eventPrice').value) || 0,
                    budget: parseFloat(document.getElementById('eventBudget').value) || 0,
                    expenses: [...currentEventExpenses],
                    media: mediaArray,
                    link: document.getElementById('eventLink').value,
                    artist: document.getElementById('eventArtist').value,
                    ideas: document.getElementById('eventIdeas').value,
                    published: document.getElementById('eventPublished').checked,
                    createdAt: new Date().toISOString()
                };
                events.push(event);
            }

            localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(events));
            closeEventModal();
            renderEvents();
        }

        function deleteEvent(id) {
            if (confirm('Sei sicuro di voler eliminare questo evento?')) {
                events = events.filter(e => e.id !== id);
                localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(events));
                renderEvents();
            }
        }

        function filterEvents(filter) {
            currentEventFilter = filter;
            
            document.querySelectorAll('#filterEventsAll, #filterEventsUpcoming, #filterEventsPast').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            
            const buttonMap = {
                'all': 'filterEventsAll',
                'upcoming': 'filterEventsUpcoming',
                'past': 'filterEventsPast'
            };
            
            document.getElementById(buttonMap[filter]).classList.add('filter-active');
            renderEvents();
        }

        function renderEvents() {
            const container = document.getElementById('eventsList');
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            let filteredEvents = events.filter(event => {
                const eventDate = new Date(event.date + 'T00:00:00');
                
                switch(currentEventFilter) {
                    case 'upcoming':
                        return eventDate >= today;
                    case 'past':
                        return eventDate < today;
                    case 'all':
                    default:
                        return true;
                }
            });

            if (filteredEvents.length === 0) {
                let emptyMessage = 'Nessun evento programmato';
                if (currentEventFilter === 'upcoming') emptyMessage = 'Nessun evento in programma';
                else if (currentEventFilter === 'past') emptyMessage = 'Nessun evento passato';
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéâ</div>
                        <div class="empty-state-text">${emptyMessage}</div>
                    </div>
                `;
                return;
            }

            const sortedEvents = filteredEvents.sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            const typeLabels = {
                'music': 'üéµ Musica Live',
                'dj': 'üéß DJ Set',
                'party': 'üéâ Festa a Tema',
                'aperitivo': 'üçπ Aperitivo Speciale',
                'sport': '‚öΩ Evento Sportivo',
                'private': 'üéÇ Evento Privato',
                'other': '‚ú® Altro'
            };

            container.innerHTML = sortedEvents.map(event => {
                const eventDate = new Date(event.date + 'T00:00:00');
                const dateFormatted = eventDate.toLocaleDateString('it-IT', { 
                    weekday: 'long',
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                });
                const isPast = eventDate < today;
                
                // Calcola totale spese
                const totalExpenses = event.expenses ? 
                    event.expenses.reduce((sum, e) => sum + (e.amount || 0), 0) : 0;
                const budget = event.budget || 0;
                const budgetRemaining = budget - totalExpenses;
                
                return `
                    <div class="event-card" style="${isPast ? 'opacity: 0.7;' : ''}">
                        <div class="event-header ${event.type}">
                            <div class="event-type-badge">${typeLabels[event.type]}</div>
                            <div class="event-title">
                                ${event.title}
                                ${event.published ? '<span class="event-status-badge published">üì¢ Pubblicato</span>' : '<span class="event-status-badge draft">‚úèÔ∏è Bozza</span>'}
                            </div>
                            <div class="event-date-time">
                                <span>üìÖ ${dateFormatted.charAt(0).toUpperCase() + dateFormatted.slice(1)}</span>
                                ${event.time ? `<span>üïê ${event.time}</span>` : ''}
                                ${isPast ? '<span style="background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 12px;">Terminato</span>' : ''}
                            </div>
                        </div>
                        <div class="event-body">
                            ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                            
                            ${budget > 0 || totalExpenses > 0 ? `
                                <div class="event-budget-summary">
                                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">üí∞ Budget & Spese</div>
                                    
                                    ${budget > 0 ? `
                                        <div class="event-budget-row">
                                            <span class="event-budget-label">Budget Preventivato</span>
                                            <span class="event-budget-value">‚Ç¨${budget.toFixed(2)}</span>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="event-budget-row">
                                        <span class="event-budget-label">Spese Sostenute</span>
                                        <span class="event-budget-value" style="color: #ff3b30;">‚Ç¨${totalExpenses.toFixed(2)}</span>
                                    </div>
                                    
                                    ${budget > 0 ? `
                                        <div class="event-budget-row">
                                            <span class="event-budget-label">${budgetRemaining >= 0 ? 'Rimanente' : 'Sforamento'}</span>
                                            <span class="event-budget-value" style="color: ${budgetRemaining >= 0 ? '#34c759' : '#ff3b30'};">
                                                ${budgetRemaining >= 0 ? '' : '-'}‚Ç¨${Math.abs(budgetRemaining).toFixed(2)}
                                            </span>
                                        </div>
                                        
                                        ${budgetRemaining < 0 ? `
                                            <div style="background: rgba(255,59,48,0.2); padding: 8px; border-radius: 6px; margin-top: 12px; text-align: center; font-size: 13px;">
                                                ‚ö†Ô∏è Budget superato del ${((totalExpenses / budget - 1) * 100).toFixed(0)}%
                                            </div>
                                        ` : ''}
                                    ` : ''}
                                    
                                    ${event.expenses && event.expenses.length > 0 ? `
                                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
                                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">Dettaglio Spese:</div>
                                            ${event.expenses.map(exp => `
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; opacity: 0.9;">
                                                    <span>‚Ä¢ ${exp.description}</span>
                                                    <span>‚Ç¨${(exp.amount || 0).toFixed(2)}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="event-info-grid">
                                ${event.artist ? `
                                    <div class="event-info-item">
                                        <div class="event-info-icon">üé§</div>
                                        <div class="event-info-text">
                                            <div class="event-info-label">Artista/Band</div>
                                            <div class="event-info-value">${event.artist}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${event.price > 0 ? `
                                    <div class="event-info-item">
                                        <div class="event-info-icon">üí∂</div>
                                        <div class="event-info-text">
                                            <div class="event-info-label">Ingresso</div>
                                            <div class="event-info-value">‚Ç¨${event.price.toFixed(2)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${event.link ? `
                                    <div class="event-info-item">
                                        <div class="event-info-icon">üîó</div>
                                        <div class="event-info-text">
                                            <div class="event-info-label">Link</div>
                                            <div class="event-info-value"><a href="${event.link}" target="_blank" style="color: #007aff; text-decoration: none;">Apri</a></div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            ${event.ideas ? `
                                <div style="background: var(--task-item-bg); padding: 12px; border-radius: 8px; margin-top: 12px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">‚úçÔ∏è Idee / To-Do</div>
                                    <div style="font-size: 14px; color: var(--text-primary); white-space: pre-wrap;">${event.ideas}</div>
                                </div>
                            ` : ''}

                            ${event.media && event.media.length > 0 ? `
                                <div style="margin-top: 16px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">üì∏ Media</div>
                                    <div class="event-media-container">
                                        ${event.media.map(media => {
                                            if (media.type.startsWith('image/')) {
                                                return `<div class="event-media-item"><img src="${media.data}" alt="${media.name}"></div>`;
                                            } else if (media.type.startsWith('video/')) {
                                                return `<div class="event-media-item"><video src="${media.data}" controls></video></div>`;
                                            }
                                            return '';
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div class="event-actions">
                                <button class="btn btn-secondary btn-edit-event" data-id="${event.id}">‚úèÔ∏è Modifica</button>
                                <button class="btn btn-danger btn-delete-event" data-id="${event.id}">üóëÔ∏è Elimina</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners
            setTimeout(() => {
                document.querySelectorAll('.btn-edit-event').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        openEventModal(id);
                    });
                });
                
                document.querySelectorAll('.btn-delete-event').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        deleteEvent(id);
                    });
                });
            }, 0);
        }

        // ========== CALENDARIO ==========
        let currentCalendarDate = new Date();
        let selectedDate = null;

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month/year display
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                               'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const container = document.getElementById('calendarGrid');
            
            let html = '<div class="calendar-grid">';
            
            // Day headers
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month days
            const prevMonthDays = startingDayOfWeek === 0 ? 0 : startingDayOfWeek;
            for (let i = prevMonthDays - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // Check if today
                const isToday = today.getDate() === day && 
                               today.getMonth() === month && 
                               today.getFullYear() === year;
                
                // Get tasks for this day
                const dayTasks = tasks.filter(t => t.date === dateStr);
                const hasTasks = dayTasks.length > 0;
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasTasks) classes += ' has-tasks';
                
                html += `<div class="${classes}" onclick="selectDay('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>`;
                
                if (hasTasks) {
                    html += '<div class="calendar-task-dots">';
                    dayTasks.slice(0, 6).forEach(task => {
                        html += `<div class="calendar-task-dot ${task.type}"></div>`;
                    });
                    if (dayTasks.length > 6) {
                        html += `<span style="font-size: 10px; color: var(--text-secondary); margin-left: 4px;">+${dayTasks.length - 6}</span>`;
                    }
                    html += '</div>';
                    
                    // Show first task preview
                    if (dayTasks[0]) {
                        html += `<div class="calendar-task-preview">${dayTasks[0].title}</div>`;
                    }
                }
                
                html += '</div>';
            }
            
            // Next month days
            const totalCells = prevMonthDays + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function selectDay(dateStr) {
            selectedDate = dateStr;
            const dayTasks = tasks.filter(t => t.date === dateStr).sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                return timeA.localeCompare(timeB);
            });
            
            if (dayTasks.length === 0) {
                document.getElementById('selectedDayCard').style.display = 'none';
                return;
            }
            
            const date = new Date(dateStr + 'T00:00:00');
            const dateFormatted = date.toLocaleDateString('it-IT', { 
                weekday: 'long',
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
            
            document.getElementById('selectedDayTitle').textContent = 
                dateFormatted.charAt(0).toUpperCase() + dateFormatted.slice(1);
            
            const container = document.getElementById('selectedDayTasks');
            container.innerHTML = dayTasks.map(task => {
                const typeLabel = task.type === 'personale' ? 'Personale' : 'Attivit√†';
                return `
                    <div class="selected-day-task ${task.type}">
                        <div class="selected-day-task-time">
                            ${task.time || 'Tutto il giorno'} ‚Ä¢ 
                            <span class="badge ${task.type}" style="margin-left: 0;">${typeLabel}</span>
                        </div>
                        <div class="selected-day-task-title">${task.title}</div>
                        ${task.notes ? `<div class="selected-day-task-notes">${task.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('selectedDayCard').style.display = 'block';
            
            // Scroll to selected day card
            setTimeout(() => {
                document.getElementById('selectedDayCard').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
            }, 100);
        }

        function closeSelectedDay() {
            document.getElementById('selectedDayCard').style.display = 'none';
            selectedDate = null;
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
            closeSelectedDay();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
            closeSelectedDay();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
            
            // Auto-select today if has tasks
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = tasks.filter(t => t.date === today);
            if (todayTasks.length > 0) {
                selectDay(today);
            } else {
                closeSelectedDay();
            }
        }

        // ========== THEME TOGGLE ==========
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeToggle = document.getElementById('themeToggle');
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('barManager_theme', newTheme);
            
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('barManager_theme') || 'light';
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            
            html.setAttribute('data-theme', savedTheme);
            themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // ========== PWA INSTALLATION ==========
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        function showInstallBanner() {
            const banner = document.createElement('div');
            banner.className = 'install-banner';
            banner.id = 'installBanner';
            banner.innerHTML = `
                <span class="install-banner-text">üì± Installa Bar Manager come app sul tuo Mac</span>
                <button onclick="installApp()" class="btn" style="padding: 8px 16px; font-size: 13px;">Installa</button>
                <button onclick="closeInstallBanner()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">Dopo</button>
            `;
            document.body.appendChild(banner);
        }

        window.installApp = async function() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('App installata!');
            }
            
            deferredPrompt = null;
            closeInstallBanner();
        };

        window.closeInstallBanner = function() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.remove();
            }
        };

        // Register inline service worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'bar-manager-v1';
                self.addEventListener('install', (e) => {
                    e.waitUntil(self.skipWaiting());
                });
                self.addEventListener('activate', (e) => {
                    e.waitUntil(self.clients.claim());
                });
                self.addEventListener('fetch', (e) => {
                    e.respondWith(
                        fetch(e.request).catch(() => caches.match(e.request))
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(() => {
                console.log('Service Worker registrato');
            }).catch(err => {
                console.log('Service Worker error:', err);
            });
        }

        // Create manifest dynamically
        const manifestData = {
            name: "Bar Manager",
            short_name: "Bar Manager",
            description: "Gestione completa del tuo bar",
            start_url: window.location.href,
            display: "standalone",
            background_color: "#f5f7fa",
            theme_color: "#007aff",
            icons: [
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='192' height='192' rx='42' fill='%23007aff'/><text x='96' y='130' font-size='80' text-anchor='middle' fill='white'>üç∫</text></svg>",
                    sizes: "192x192",
                    type: "image/svg+xml"
                },
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='512' height='512' rx='112' fill='%23007aff'/><text x='256' y='340' font-size='220' text-anchor='middle' fill='white'>üç∫</text></svg>",
                    sizes: "512x512",
                    type: "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestURL;
        document.head.appendChild(manifestLink);

        // L'inizializzazione avviene solo dopo l'autenticazione (vedi initializeApp())
    </script>
</body>
</html>
